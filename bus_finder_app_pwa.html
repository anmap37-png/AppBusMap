<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>BusMaps ‚Äì H√† N·ªôi</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --card: rgba(16, 24, 40, 0.72);
      --card2: rgba(16, 24, 40, 0.88);
      --border: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --shadow: 0 18px 45px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 24px;
      --safe-b: env(safe-area-inset-bottom, 0px);
      --safe-t: env(safe-area-inset-top, 0px);
    }
    *{box-sizing:border-box}
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #050a14; color: var(--text); }
    #map { height: 100dvh; width: 100vw; }
    .leaflet-control-attribution{ display:none; }

    /* Topbar: search + POIs */
    .topbar{
      position: fixed;
      left: 12px;
      right: 12px;
      top: calc(12px + var(--safe-t));
      z-index: 5000;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .search{
      flex:1;
      display:flex; align-items:center; gap:10px;
      background: var(--card2);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: 999px;
      padding: 10px 12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      min-height: 44px;
    }
    .search input{
      flex:1;
      border:none; outline:none;
      background: transparent;
      color: var(--text);
      font-size: 14px;
      font-weight: 650;
    }
    .search input::placeholder{color: rgba(255,255,255,.55); font-weight: 650}
    .chip{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 999px;
      padding: 8px 10px;
      font-weight: 750;
      cursor:pointer;
      user-select:none;
    }
    .chip:active{transform: translateY(1px)}
    .chip[disabled]{opacity:.45; pointer-events:none}

    /* N√∫t Du l·ªãch (n·ªïi b·∫≠t h∆°n) */
    #btnPOIs{
      border: 1px solid rgba(255, 196, 0, .55);
      background: linear-gradient(135deg, rgba(255, 196, 0, .22), rgba(255, 90, 0, .12));
      box-shadow: 0 10px 22px rgba(255, 160, 0, .18);
    }
    #btnPOIs:hover{
      border-color: rgba(255, 196, 0, .78);
      background: linear-gradient(135deg, rgba(255, 196, 0, .28), rgba(255, 90, 0, .18));
    }

    /* Floating controls */
    .fab-col{
      position: fixed;
      right: 12px;
      bottom: calc(12px + var(--safe-b) + 92px);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 5000;
    }
    .fab{
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: var(--card2);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      color: var(--text);
      font-weight: 750;
      font-size: 14px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      cursor: pointer;
      user-select: none;
      max-width: min(74vw, 320px);
    }
    .fab:active{transform: translateY(1px)}
    .fab .dot{ width: 10px; height: 10px; border-radius: 999px; background: rgba(255,255,255,.35); }
    .fab.active .dot{ background: #5aa9ff; }
    .fab[disabled]{opacity:.45; pointer-events:none}

    /* Toggle all controls */
    .fab-group{
      display:flex;
      flex-direction: column;
      gap: 10px;
      overflow: hidden;
      max-height: 800px;
      opacity: 1;
      transform: translateY(0) scale(1);
      transform-origin: top right;
      transition: max-height 220ms ease, opacity 220ms ease, transform 220ms ease;
      will-change: max-height, opacity, transform;
    }
    .fab-group.hidden{
      max-height: 0px;
      opacity: 0;
      transform: translateY(-8px) scale(0.985);
      pointer-events: none;
    }

    
/* Toast */
.toast{
  position: fixed;
  left: 50%;
  right: auto;
  bottom: calc(12px + var(--safe-b) + 12px);
  transform: translateX(-50%);
  z-index: 5100;

  /* Compact, non-intrusive */
  max-width: min(520px, calc(100vw - 24px));
  width: fit-content;
  padding: 8px 12px;
  border-radius: 999px;

  background: rgba(10, 18, 32, 0.90);
  border: 1px solid rgba(255,255,255,0.10);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);

  display: none;
  font-weight: 650;
  font-size: 13.5px;
  line-height: 1.2;

  /* Keep it short */
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;

  pointer-events: none;
  user-select: none;
}
.toast.show{display:block}
.toast.ok{
  border-color: rgba(34,197,94,0.35);
  box-shadow: 0 10px 28px rgba(34,197,94,0.12);
}
.toast.warn{
  border-color: rgba(245,158,11,0.35);
  box-shadow: 0 10px 28px rgba(245,158,11,0.12);
}
.toast.err{
  border-color: rgba(239,68,68,0.35);
  box-shadow: 0 10px 28px rgba(239,68,68,0.12);
}
    .toast.ok{border-color: rgba(55,214,122,.35)}
    .toast.err{border-color: rgba(255,77,79,.45)}
    .toast.warn{border-color: rgba(246,195,67,.45)}
    .toast small{display:block; font-weight:650; color: var(--muted); margin-top:4px}

    /* Bottom sheet */
    .sheet{
      position: fixed;
      left: 0; right: 0;
      bottom: 0;
      z-index: 6000;
      background: rgba(10, 18, 32, 0.92);
      border-top: 1px solid var(--border);
      border-top-left-radius: var(--radius2);
      border-top-right-radius: var(--radius2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding-bottom: var(--safe-b);
      transform: translateY(calc(100% - 92px));
      transition: transform 220ms ease, opacity 200ms ease;
      will-change: transform;
    }
    .sheet.expanded{ transform: translateY(0%); }
    
    .sheet.hidden{
      transform: translateY(110%);
      opacity: 0;
      pointer-events: none;
    }
    .sheet.hidden.expanded{
      transform: translateY(110%);
    }
.handle{
      width: 48px; height: 5px;
      border-radius: 999px;
      background: rgba(255,255,255,.18);
      margin: 10px auto 8px;
      cursor: grab;
      touch-action: pan-y;
    }
    .sheet-header{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 0 14px 12px;
    }
    .title{font-weight: 850; font-size: 15px; line-height: 1.2}
    .subtitle{color: var(--muted); font-weight: 650; font-size: 12.5px; margin-top: 3px; white-space: nowrap; overflow:hidden; text-overflow: ellipsis; max-width: 76vw;}
    .icon-btn{
      width: 38px; height: 38px;
      display:flex; align-items:center; justify-content:center;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 900;
      cursor:pointer;
      user-select:none;
    }
    .icon-btn:active{transform: translateY(1px)}
    .sheet-body{
      padding: 0 14px 14px;
      max-height: min(68vh, 520px);
      overflow: auto;
    }
    .card{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 10px;
    }
    .row{display:flex; align-items:center; justify-content: space-between; gap: 12px; flex-wrap: wrap;}
    .k{color: var(--muted); font-weight: 700; font-size: 12.5px}
    .v{font-weight: 850; font-size: 13.5px}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      padding: 6px 10px;
      font-weight: 800;
      font-size: 12px;
    }
    .btn{
      width: 100%;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-weight: 850;
      border-radius: 14px;
      padding: 10px 12px;
      cursor: pointer;
      user-select:none;
      text-align:center;
      margin-top: 10px;
    }
    .btn:active{transform: translateY(1px)}
    .btn.danger{border-color: rgba(255,77,79,.45); background: rgba(255,77,79,.10)}
    .btn.primary{border-color: rgba(90,169,255,.45); background: rgba(90,169,255,.14)}

    .seg{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 10px 10px;
      margin-top: 10px;
    }
    .seg h4{ margin: 0 0 6px; font-size: 13.5px; font-weight: 900; }
    .seg p{ margin: 0; color: var(--muted); font-weight: 650; font-size: 12.5px; line-height: 1.35 }
    .seg-actions{ display:flex; gap:10px; margin-top: 8px }
    .seg-actions .mini{
      flex:1;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      padding: 9px 10px;
      font-weight: 850;
      cursor: pointer;
      user-select:none;
      text-align:center;
    }
    .seg-actions .mini:active{transform: translateY(1px)}

    /* Subsheet */
    .subsheet{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 7000;
      background: rgba(10,18,32,0.96);
      border-top: 1px solid var(--border);
      border-top-left-radius: var(--radius2);
      border-top-right-radius: var(--radius2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding-bottom: var(--safe-b);
      transform: translateY(100%);
      transition: transform 220ms ease, opacity 200ms ease;
    }
    .subsheet.open{transform: translateY(0%)}
    .subhead{ display:flex; align-items:center; gap:10px; padding: 10px 14px 12px; }
    .back{
      width: 40px; height: 40px; border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:center;
      font-weight: 900;
      cursor:pointer;
      user-select:none;
    }
    .subtitle2{ font-weight: 900; font-size: 14px; line-height: 1.2; margin: 0; }
    .hint{ color: rgba(255,255,255,.85); font-weight: 750; font-size: 12.5px; margin: 6px 0 0; }
    .subbody{ padding: 0 14px 14px; max-height: min(70vh, 560px); overflow:auto; }
    .list-item{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 10px 12px;
      margin-top: 10px;
      cursor:pointer;
      user-select:none;
    }
    .list-item:active{transform: translateY(1px)}
    .list-item .name{font-weight: 900}
    .list-item .meta{color: var(--muted); font-weight: 650; font-size: 12.5px; margin-top: 3px}
  
    /* ===== POI detail modal ===== */
    .poi-modal{
      position: fixed;
      inset: 0;
      z-index: 9000;
      display: none;
    }
    .poi-modal.show{ display:block; }
    .poi-backdrop{
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .poi-panel{
      position: absolute;
      left: 12px; right: 12px;
      top: calc(12px + var(--safe-t));
      bottom: calc(12px + var(--safe-b));
      background: rgba(10,18,32,0.96);
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .poi-head{
      padding: 12px 14px 10px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
    }
    .poi-head h3{ margin:0; font-size: 16px; font-weight: 950; line-height: 1.15; }
    .poi-head p{ margin: 6px 0 0; color: var(--muted); font-weight: 650; font-size: 12.8px; line-height: 1.35; }
    .poi-close{
      width: 40px; height: 40px;
      display:flex; align-items:center; justify-content:center;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      flex: 0 0 auto;
    }
    .poi-close:active{ transform: translateY(1px); }

    .poi-back{
      width: 40px; height: 40px;
      display:flex; align-items:center; justify-content:center;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      flex: 0 0 auto;
    }
    .poi-back:active{ transform: translateY(1px); }

    .poi-body{
      padding: 12px 14px 14px;
      overflow: auto;
    }
    .poi-gallery{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius: 18px;
      padding: 10px;
      --poiMainH: min(52vh, 420px);
    }
    .poi-gallery.portrait{ --poiMainH: min(64vh, 600px); }
    .poi-main-wrap{
      width: 100%;
      height: var(--poiMainH);
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,0.22);
    }
    .poi-main{
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
      display:block;
    }
    .poi-gbar{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 10px;
    }
    .poi-nav{
      display:flex;
      gap: 8px;
    }
    .poi-nav button{
      width: 44px; height: 40px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 950;
      cursor: pointer;
      user-select:none;
    }
    .poi-nav button:active{ transform: translateY(1px); }
    .poi-count{
      color: var(--muted);
      font-weight: 750;
      font-size: 12.5px;
      white-space: nowrap;
    }
    .poi-thumbs{
      display:flex;
      gap: 8px;
      overflow-x: auto;
      margin-top: 10px;
      padding-bottom: 4px;
    }
    .poi-thumb{
      width: 84px; height: 58px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      opacity: .80;
      cursor: pointer;
      user-select:none;
      flex: 0 0 auto;
      background: rgba(255,255,255,.02);
    }
    .poi-thumb.active{
      opacity: 1;
      border-color: rgba(90,169,255,.55);
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
    }

    .poi-note{
      margin-top: 10px;
      color: rgba(255,255,255,.82);
      font-weight: 700;
      font-size: 12.8px;
      line-height: 1.35;
    }
/* ===== Landing / Intro styles ===== */
:root{
  --intro-bg: #0c3e54;     /* xanh ƒë·∫≠m nh∆∞ m·∫´u */
  --intro-panel: #0b2f3e;  /* panel tr√°i ƒë·∫≠m h∆°n */
  --intro-yellow: #ffd400; /* ch·ªØ PUBLIC m√†u v√†ng */
  --intro-white: #ffffff;
}

.intro-overlay{
  position: fixed;
  inset: 0;
  z-index: 100000;
  display: none; /* m·∫∑c ƒë·ªãnh ·∫©n, JS s·∫Ω b·∫≠t */
  align-items: center;
  justify-content: center;
  padding: 18px;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(10px);
}

.intro-overlay.is-open{ display:flex; }

.intro-card{
  width: min(980px, 100%);
  height: min(520px, 92vh);
  border-radius: 14px;
  overflow: hidden;
  display: grid;
  grid-template-columns: 1.05fr 0.95fr;
  box-shadow: 0 26px 90px rgba(0,0,0,0.55);
  border: 1px solid rgba(255,255,255,0.10);
  background: var(--intro-bg);
}

/* Left */
.intro-left{
  padding: 26px 28px;
  background: linear-gradient(180deg, rgba(7,26,37,0.78), rgba(6,20,28,0.88));
  display:flex;
  flex-direction: column;
  gap: 14px;
}

.intro-credit{
  font-size: 14px;
  color: rgba(255,255,255,0.85);
}
.intro-author{
  color: var(--intro-yellow);
  font-weight: 800;
}

.intro-line{
  height: 2px;
  background: rgba(255,255,255,0.18);
  width: 100%;
}

.intro-title{
  margin-top: 8px;
  line-height: 0.95;
}

.intro-title-public{
  font-size: clamp(42px, 7vw, 78px);
  font-weight: 900;
  letter-spacing: 1px;
  color: var(--intro-yellow);
}

.intro-title-transport{
  font-size: clamp(46px, 7.8vw, 86px);
  font-weight: 950;
  letter-spacing: 1px;
  color: var(--intro-white);
  margin-top: 6px;
}

.intro-sub{
  margin-top: auto;
  font-size: 14px;
  color: rgba(255,255,255,0.80);
}

/* Actions */
.intro-actions{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
  margin-top: 10px;
}

.intro-skip{
  display:flex;
  align-items:center;
  gap: 8px;
  font-size: 13px;
  color: rgba(255,255,255,0.85);
}

.intro-btn{
  padding: 10px 14px;
  border-radius: 12px;
  font-weight: 900;
  border: 1px solid rgba(255, 212, 0, 0.35);
  background: rgba(255, 212, 0, 0.18);
  color: #fff;
  cursor: pointer;
}
.intro-btn:hover{
  background: rgba(255, 212, 0, 0.26);
}

/* Right image */
.intro-right{
  position: relative;
  background:
    linear-gradient(90deg, rgba(10,30,42,0.25), rgba(10,30,42,0.05)),
    url("/assets/landing_bus.jpg"); /* <- b·∫°n ƒë·ªïi ƒë∆∞·ªùng d·∫´n ·∫£nh t·∫°i ƒë√¢y */
  background-size: cover;
  background-position: center;
  filter: grayscale(1) contrast(1.1) brightness(0.95);
}

/* Responsive: mobile stack */
@media (max-width: 860px){
  .intro-card{
    grid-template-columns: 1fr;
    height: auto;
    max-height: 92vh;
  }
  .intro-right{
    min-height: 220px;
    order: -1; /* ·∫£nh l√™n tr√™n */
  }
}
/* ===== End Landing / Intro styles ===== */

  
/* ====== Tourism list buttons ====== */
.li-actions{ display:flex; gap:8px; align-items:center; }
.mini-btn{
  padding: 6px 10px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.12);
  color: #fff;
  font-weight: 600;
  cursor: pointer;
  white-space: nowrap;
}
.mini-btn:hover{ background: rgba(255,255,255,.18); }
.mini-btn.ghost{
  background: transparent;
  border: 1px solid rgba(255,255,255,.14);
  color: rgba(255,255,255,.86);
}
.li-title{ font-weight:700; margin-bottom: 2px; }
.li-sub{ font-size: 12px; opacity: .8; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; }

</style>

    <!-- PWA -->
    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="theme-color" content="#0b1020">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BusMap Plus">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    
</head>

<body>
  <!-- ===== Landing / Intro Overlay ===== -->
<div id="introOverlay" class="intro-overlay" aria-hidden="true">
  <div class="intro-card">
    <!-- Left panel -->
    <section class="intro-left">
      <div class="intro-credit">
        Create By <span class="intro-author">_NGDAN89</span>
      </div>

      <div class="intro-line"></div>

      <div class="intro-title">
        <div class="intro-title-public">PUBLIC</div>
        <div class="intro-title-transport">TRANSPORTATION</div>
      </div>

      <div class="intro-line"></div>

      <div class="intro-sub">
        BusMaps H√† N·ªôi ‚Ä¢ T√¨m tr·∫°m g·∫ßn nh·∫•t ‚Ä¢ G·ª£i √Ω l·ªô tr√¨nh ‚Ä¢ ƒêi·ªÉm du l·ªãch
      </div>

      <div class="intro-actions">
        <label class="intro-skip">
          <input id="introSkip" type="checkbox" />
          Kh√¥ng hi·ªán l·∫°i l·∫ßn sau
        </label>

        <button id="btnStartApp" class="intro-btn">
          ‚ñ∂ B·∫Øt ƒë·∫ßu
        </button>
      </div>
    </section>

    <!-- Right panel (bus photo) -->
    <section class="intro-right" role="img" aria-label="Bus photo"></section>
  </div>
</div>
<!-- ===== End Landing / Intro Overlay ===== -->

  <div id="map"></div>

  <div class="topbar">
    <div class="search">
      <span>üîé</span>
      <input id="placeInput" placeholder="T√¨m ƒë·ªãa ƒëi·ªÉm ·ªü H√† N·ªôi (v√≠ d·ª•: B·∫øn xe M·ªπ ƒê√¨nh)" autocomplete="off" />
      <button id="btnPlaceGo" class="chip">ƒêi</button>
    </div>
    <button id="btnPOIs" class="chip">üèõÔ∏è Du l·ªãch</button>
  </div>

  <div class="fab-col">
    <div class="fab active" id="btnToggleControls" title="B·∫≠t/T·∫Øt c√°c ph√≠m ch·ª©c nƒÉng">
      <span class="dot"></span><span class="ico">‚úï</span> <span class="label">·∫®n ph√≠m ch·ª©c nƒÉng</span>
    </div>
    <div class="fab-group" id="fabGroup">
      <div class="fab" id="btnGPS"><span class="dot"></span>üß≠ <span>V·ªã tr√≠ c·ªßa t√¥i</span></div>
      <div class="fab" id="btnPickStart"><span class="dot"></span>üü¢ <span>Ch·ªçn ƒëi·ªÉm xu·∫•t ph√°t</span></div>
      <div class="fab" id="btnPickDest"><span class="dot"></span>üìç <span>Ch·ªçn ƒëi·ªÉm ƒë·∫øn</span></div>
      <div class="fab" id="btnToggleStops"><span class="dot"></span>üöè <span>Hi·ªán tr·∫°m xe</span></div>
      <div class="fab" id="btnNearest"><span class="dot"></span>üìå <span>Tr·∫°m g·∫ßn t√¥i</span></div>
      <div class="fab" id="btnClear"><span class="dot"></span>üßπ <span>Xo√° l·ªô tr√¨nh</span></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="sheet hidden" id="sheet">
    <div class="handle" id="handle" aria-label="K√©o ƒë·ªÉ m·ªü/ƒë√≥ng"></div>
    <div class="sheet-header">
      <div style="min-width:0">
        <div class="title" id="sheetTitle">L·ªô tr√¨nh</div>
        <div class="subtitle" id="sheetSubtitle">Ch·ªçn ƒëi·ªÉm ƒë·∫øn ƒë·ªÉ xem l·ªô tr√¨nh</div>
      </div>
      <div style="display:flex; gap:8px">
        <div class="icon-btn" id="btnExpand" title="M·ªü r·ªông">‚§¢</div>
        <div class="icon-btn" id="btnCloseSheet" title="·∫®n">√ó</div>
      </div>
    </div>
    <div class="sheet-body" id="sheetBody"></div>
  </div>

  <div class="subsheet" id="subsheet" aria-hidden="true">
    <div class="subhead">
      <div class="back" id="subBack" title="Quay l·∫°i">‚Üê</div>
      <div style="min-width:0">
        <p class="subtitle2" id="subTitle">Danh s√°ch</p>
        <p class="hint" id="subHint"></p>
      </div>
    </div>
    <div class="subbody" id="subBody"></div>
  </div>


  <!-- POI detail modal -->
  <div class="poi-modal" id="poiModal" aria-hidden="true">
    <div class="poi-backdrop" id="poiBackdrop"></div>
    <div class="poi-panel" role="dialog" aria-modal="true" aria-labelledby="poiModalTitle">
      <div class="poi-head">
        <div class="poi-back" id="poiModalBack" title="Quay l·∫°i">‚Üê</div>
        <div style="min-width:0; flex:1">
          <h3 id="poiModalTitle">ƒêi·ªÉm du l·ªãch</h3>
          <p id="poiModalIntro">Gi·ªõi thi·ªáu</p>
        </div>
        <div class="poi-close" id="poiModalClose" title="ƒê√≥ng">√ó</div>
      </div>
      <div class="poi-body">
        <div class="poi-gallery" id="poiGallery">
          <div class="poi-main-wrap" id="poiMainWrap">
            <img id="poiMainImg" class="poi-main" alt="·∫¢nh ƒëi·ªÉm du l·ªãch" />
          </div>
          <div class="poi-gbar">
            <div class="poi-nav">
              <button id="poiPrev" title="·∫¢nh tr∆∞·ªõc">‚Äπ</button>
              <button id="poiNext" title="·∫¢nh sau">‚Ä∫</button>
            </div>
            <div class="poi-count" id="poiCount">1/1</div>
          </div>
          <div class="poi-thumbs" id="poiThumbs"></div>
        </div>

        <div class="poi-note" id="poiExtraNote"></div>
      </div>
    </div>
  </div>


<script>
(() => {
  const API_BASE = `${location.origin}/api`;

  // ====== ƒêi·ªÉm du l·ªãch n·ªïi ti·∫øng (H√† N·ªôi) ======
  const TOUR_POIS = [
    { id:"ho_guom", name:"H·ªì Ho√†n Ki·∫øm", lat:21.028511, lon:105.852019, note:"Trung t√¢m H√† N·ªôi" },
    { id:"pho_co", name:"Ph·ªë c·ªï H√† N·ªôi", lat:21.035463, lon:105.850847, note:"Khu ph·ªë ƒëi b·ªô/·∫©m th·ª±c" },
    { id:"van_mieu", name:"VƒÉn Mi·∫øu ‚Äì Qu·ªëc T·ª≠ Gi√°m", lat:21.027763, lon:105.835091, note:"Di t√≠ch l·ªãch s·ª≠" },
    { id:"lang_bac", name:"LƒÉng Ch·ªß t·ªãch H·ªì Ch√≠ Minh", lat:21.036874, lon:105.834676, note:"Qu·∫£ng tr∆∞·ªùng Ba ƒê√¨nh" },
    { id:"chua_mot_cot", name:"Ch√πa M·ªôt C·ªôt", lat:21.035911, lon:105.832401, note:"G·∫ßn LƒÉng B√°c" },
    { id:"tran_quoc", name:"Ch√πa Tr·∫•n Qu·ªëc", lat:21.048117, lon:105.836164, note:"H·ªì T√¢y" },
    { id:"ho_tay", name:"H·ªì T√¢y", lat:21.055407, lon:105.818146, note:"D·∫°o quanh h·ªì" },
    { id:"hoang_thanh", name:"Ho√†ng th√†nh ThƒÉng Long", lat:21.035758, lon:105.840548, note:"Di s·∫£n UNESCO" },
    { id:"nha_tho_lon", name:"Nh√† th·ªù L·ªõn H√† N·ªôi", lat:21.028748, lon:105.848968, note:"G·∫ßn h·ªì Ho√†n Ki·∫øm" },
    { id:"nha_hat_lon", name:"Nh√† h√°t L·ªõn H√† N·ªôi", lat:21.024489, lon:105.857133, note:"Ki·∫øn tr√∫c Ph√°p" },
    { id:"cau_long_bien", name:"C·∫ßu Long Bi√™n", lat:21.045256, lon:105.854755, note:"Check-in bu·ªïi t·ªëi" },
    { id:"bao_tang_dth", name:"B·∫£o t√†ng D√¢n t·ªôc h·ªçc", lat:21.040595, lon:105.800240, note:"C·∫ßu Gi·∫•y" },
    { id:"lotte", name:"Lotte Center Hanoi", lat:21.031401, lon:105.813484, note:"View sky deck" },
    { id:"ben_xe_my_dinh", name:"B·∫øn xe M·ªπ ƒê√¨nh", lat:21.028885, lon:105.778470, note:"Trung chuy·ªÉn l·ªõn" }
  ];

  // ===== POI chi ti·∫øt (·∫£nh + gi·ªõi thi·ªáu) =====
  // G·ª£i √Ω: B·∫°n c√≥ th·ªÉ thay c√°c ·∫£nh "placeholder" b·∫±ng ·∫£nh th·∫≠t:
  // - ·∫¢nh online: "https://....jpg"
  // - ·∫¢nh local:  "/static/pois/vanmieu_1.jpg" (n·∫øu b·∫°n t·ª± ph·ª•c v·ª• file tƒ©nh)
  function svgPlaceholder(title, subtitle){
    const safeTitle = String(title || "").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    const safeSub = String(subtitle || "").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="700" viewBox="0 0 1200 700">
        <defs>
          <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0" stop-color="#0b1b33"/>
            <stop offset="1" stop-color="#102a44"/>
          </linearGradient>
        </defs>
        <rect width="1200" height="700" fill="url(#g)"/>
        <rect x="40" y="40" width="1120" height="620" rx="44" fill="rgba(255,255,255,0.06)" stroke="rgba(255,255,255,0.14)"/>
        <text x="80" y="160" fill="rgba(255,255,255,0.92)" font-size="64" font-family="system-ui, -apple-system, Segoe UI, Roboto, Arial" font-weight="900">
          ${safeTitle}
        </text>
        <text x="80" y="240" fill="rgba(255,255,255,0.72)" font-size="34" font-family="system-ui, -apple-system, Segoe UI, Roboto, Arial" font-weight="650">
          ${safeSub}
        </text>
        <text x="80" y="620" fill="rgba(255,255,255,0.58)" font-size="26" font-family="system-ui, -apple-system, Segoe UI, Roboto, Arial" font-weight="650">
          (·∫¢nh minh ho·∫° ‚Äì b·∫°n c√≥ th·ªÉ thay b·∫±ng ·∫£nh th·∫≠t)
        </text>
      </svg>
    `.trim();
    return "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg);
  }

  // ============ ·∫¢nh online (Wikimedia ∆∞u ti√™n, fallback Unsplash) + cache ============
  const POI_IMAGE_COUNT = 10;
  const POI_IMG_CACHE_TTL_MS = 14 * 24 * 60 * 60 * 1000; // 14 ng√†y

  function _poiImgCacheKey(poiId){ return `bm_poi_imgs_v1_${poiId}`; }
  function _getCachedPoiImages(poiId){
    try{
      const raw = localStorage.getItem(_poiImgCacheKey(poiId));
      if (!raw) return null;
      const j = JSON.parse(raw);
      if (!j || !Array.isArray(j.urls) || !j.urls.length) return null;
      if (j.ts && (Date.now() - Number(j.ts)) > POI_IMG_CACHE_TTL_MS) return null;
      return j.urls.filter(Boolean);
    }catch{ return null; }
  }
  function _setCachedPoiImages(poiId, urls){
    try{
      localStorage.setItem(_poiImgCacheKey(poiId), JSON.stringify({ ts: Date.now(), urls: (urls||[]).filter(Boolean) }));
    }catch{}
  }

  function unsplashImages(keyword, count = POI_IMAGE_COUNT){
    const k = encodeURIComponent(keyword);
    // Unsplash source: kh√¥ng c·∫ßn token, nh∆∞ng ·∫£nh c√≥ th·ªÉ thay ƒë·ªïi theo th·ªùi ƒëi·ªÉm.
    return Array.from({length: count}, (_, i) => `https://source.unsplash.com/featured/1200x800/?${k}&sig=${i+1}`);
  }

  async function wikimediaImages(keyword, count = POI_IMAGE_COUNT){
    try {
      const q = String(keyword || '').trim();
      if (!q) return [];
      // 1) search File: pages (namespace 6)
      const u1 = `https://commons.wikimedia.org/w/api.php?action=query&list=search&srnamespace=6&srlimit=${Math.max(8, count*3)}&srsearch=${encodeURIComponent(q)}&format=json&origin=*`;
      const j1 = await fetch(u1).then(r => r.json()).catch(() => null);
      const titles = (j1?.query?.search || []).map(x => x.title).filter(t => /^File:/i.test(t));
      if (!titles.length) return [];

      // 2) fetch imageinfo (thumburl)
      const joined = titles.slice(0, Math.max(12, count*3)).join('|');
      const u2 = `https://commons.wikimedia.org/w/api.php?action=query&titles=${encodeURIComponent(joined)}&prop=imageinfo&iiprop=url&iiurlwidth=1200&format=json&origin=*`;
      const j2 = await fetch(u2).then(r => r.json()).catch(() => null);
      const pages = j2?.query?.pages || {};
      const out = [];
      for (const k of Object.keys(pages)){
        const ii = pages[k]?.imageinfo?.[0];
        const url = ii?.thumburl || ii?.url;
        if (!url) continue;
        if (!/\.(jpg|jpeg|png|webp)(\?|$)/i.test(url)) continue;
        out.push(url);
      }
      return out.slice(0, count);
    } catch {
      return [];
    }
  }

  async function getPoiImages(poi){
    const poiId = poi?.id || '';
    if (!poiId) return [svgPlaceholder(poi?.name || 'POI', 'Kh√¥ng c√≥ d·ªØ li·ªáu')];

    const cached = _getCachedPoiImages(poiId);
    if (cached && cached.length >= 3){
      // ƒë·∫£m b·∫£o ƒë·ªß 10 ·∫£nh (n·∫øu cache √≠t h∆°n)
      if (cached.length >= POI_IMAGE_COUNT) return cached.slice(0, POI_IMAGE_COUNT);
      const d = POI_DETAILS[poiId] || {};
      const kw = (d.keyword || poi.name || '').trim();
      return cached.concat(unsplashImages(kw + ' Hanoi', POI_IMAGE_COUNT - cached.length));
    }

    const d = POI_DETAILS[poiId] || {};
    const kw = (d.keyword || poi.name || '').trim();
    const wiki = await wikimediaImages(kw + ' Hanoi', POI_IMAGE_COUNT);

    let urls = wiki && wiki.length ? wiki : [];
    if (urls.length < POI_IMAGE_COUNT){
      urls = urls.concat(unsplashImages(kw + ' Hanoi', POI_IMAGE_COUNT - urls.length));
    }
    urls = urls.slice(0, POI_IMAGE_COUNT);
    if (urls.length) _setCachedPoiImages(poiId, urls);
    return urls.length ? urls : [svgPlaceholder(poi?.name || 'POI', 'Kh√¥ng t·∫£i ƒë∆∞·ª£c ·∫£nh')];
  }

  // ===== POI chi ti·∫øt (gi·ªõi thi·ªáu + ƒë·ªãa ch·ªâ/gi·ªù/gi√° + tips bus) =====
  // L∆∞u √Ω: Gi·ªù m·ªü c·ª≠a/gi√° v√© c√≥ th·ªÉ thay ƒë·ªïi theo th·ªùi ƒëi·ªÉm. B·∫°n c√≥ th·ªÉ ch·ªânh tr·ª±c ti·∫øp t·∫°i ƒë√¢y.
  const POI_DETAILS = {
    ho_guom: {
      keyword: 'Hoan Kiem Lake',
      intro: `H·ªì Ho√†n Ki·∫øm (H·ªì G∆∞∆°m) l√† bi·ªÉu t∆∞·ª£ng trung t√¢m c·ªßa H√† N·ªôi, g·∫Øn v·ªõi truy·ªÅn thuy·∫øt vua L√™ tr·∫£ g∆∞∆°m v√† kh√¥ng gian ƒëi b·ªô quanh h·ªì. Khu v·ª±c n√†y r·∫•t ph√π h·ª£p ƒë·ªÉ d·∫°o b·ªô, ch·ª•p ·∫£nh Th√°p R√πa, ƒê·ªÅn Ng·ªçc S∆°n v√† tr·∫£i nghi·ªám nh·ªãp s·ªëng ph·ªë c·ªï.`,
      address: `Khu v·ª±c h·ªì Ho√†n Ki·∫øm, qu·∫≠n Ho√†n Ki·∫øm, H√† N·ªôi`,
      hours: `Kh√¥ng gi·ªõi h·∫°n (khu v·ª±c c√¥ng c·ªông). Ph·ªë ƒëi b·ªô quanh h·ªì th∆∞·ªùng ho·∫°t ƒë·ªông cu·ªëi tu·∫ßn (th∆∞·ªùng t·ª´ 19:00 Th·ª© S√°u ƒë·∫øn 24:00 Ch·ªß Nh·∫≠t).`,
      ticket: `Mi·ªÖn ph√≠`,
      busTips: [
        `ƒêi bus ƒë·∫øn khu v·ª±c Tr√†ng Thi / B·ªù H·ªì, sau ƒë√≥ ƒëi b·ªô 3‚Äì10 ph√∫t.`,
        `N·∫øu ƒëi cu·ªëi tu·∫ßn (ph·ªë ƒëi b·ªô), n√™n xu·ªëng s·ªõm h∆°n m·ªôt tr·∫°m ƒë·ªÉ tr√°nh c·∫•m ƒë∆∞·ªùng.`
      ],
      note: `G·ª£i √Ω: cu·ªëi tu·∫ßn th∆∞·ªùng c√≥ ph·ªë ƒëi b·ªô; bu·ªïi t·ªëi m√°t v√† nhi·ªÅu ho·∫°t ƒë·ªông.`
    },
    pho_co: {
      keyword: 'Hanoi Old Quarter',
      intro: `Ph·ªë c·ªï H√† N·ªôi l√† khu ph·ªë l√¢u ƒë·ªùi v·ªõi m·∫°ng l∆∞·ªõi 36 ph·ªë ph∆∞·ªùng, n·ªïi ti·∫øng b·ªüi ki·∫øn tr√∫c nh√† ·ªëng, ·∫©m th·ª±c ƒë∆∞·ªùng ph·ªë v√† kh√¥ng kh√≠ s·∫ßm u·∫•t. ƒê√¢y l√† n∆°i ‚Äúv√†o mood‚Äù H√† N·ªôi nh·∫•t v·ªõi c√† ph√™, ch·ª£ ƒë√™m v√† v√¥ s·ªë g√≥c check‚Äëin.`,
      address: `Khu ph·ªë c·ªï, qu·∫≠n Ho√†n Ki·∫øm, H√† N·ªôi`,
      hours: `Khu ph·ªë ho·∫°t ƒë·ªông c·∫£ ng√†y; ch·ª£ ƒë√™m th∆∞·ªùng cu·ªëi tu·∫ßn.`,
      ticket: `Mi·ªÖn ph√≠`,
      busTips: [
        `N√™n xu·ªëng bus ·ªü c√°c ƒëi·ªÉm r√¨a ph·ªë c·ªï (H√†ng ƒê·∫≠u/Tr·∫ßn Quang Kh·∫£i/Tr√†ng Thi) r·ªìi ƒëi b·ªô v√†o trong.`,
        `ƒêi b·ªô l√† h·ª£p l√Ω nh·∫•t, tr√°nh gi·ªù cao ƒëi·ªÉm n·∫øu di chuy·ªÉn b·∫±ng xe.`
      ],
      note: `G·ª£i √Ω: ƒëi b·ªô l√† h·ª£p l√Ω nh·∫•t; tr√°nh gi·ªù cao ƒëi·ªÉm n·∫øu di chuy·ªÉn b·∫±ng xe.`
    },
    van_mieu: {
      keyword: 'Temple of Literature Hanoi',
      intro: `VƒÉn Mi·∫øu ‚Äì Qu·ªëc T·ª≠ Gi√°m l√† qu·∫ßn th·ªÉ di t√≠ch ti√™u bi·ªÉu c·ªßa H√† N·ªôi, g·∫Øn v·ªõi truy·ªÅn th·ªëng hi·∫øu h·ªçc v√† vƒÉn h√≥a khoa b·∫£ng. N∆°i ƒë√¢y th·ªù Kh·ªïng T·ª≠, c√°c b·∫≠c hi·ªÅn tri·∫øt v√† l∆∞u gi·ªØ h·ªá th·ªëng bia Ti·∫øn sƒ© ‚Äì d·∫•u ·∫•n l·ªãch s·ª≠ gi√°o d·ª•c Vi·ªát Nam.`,
      address: `58 Qu·ªëc T·ª≠ Gi√°m, ph∆∞·ªùng VƒÉn Mi·∫øu, qu·∫≠n ƒê·ªëng ƒêa, H√† N·ªôi`,
      hours: `M√πa h√® (01/4‚Äì31/10): 07:30‚Äì17:30 ‚Ä¢ M√πa ƒë√¥ng (01/11‚Äì31/3): 08:00‚Äì17:00`,
      ticket: `Tham kh·∫£o: ~70.000ƒë/ng∆∞·ªùi l·ªõn (c√≥ th·ªÉ thay ƒë·ªïi)`,
      busTips: [
        `Xu·ªëng bus g·∫ßn ph·ªë Qu·ªëc T·ª≠ Gi√°m / T√¥n ƒê·ª©c Th·∫Øng r·ªìi ƒëi b·ªô 5‚Äì10 ph√∫t.`,
        `ƒêi s·ªõm ƒë·ªÉ tr√°nh ƒë√¥ng, ƒë·∫∑c bi·ªát cu·ªëi tu·∫ßn.`
      ],
      note: `G·ª£i √Ω: n√™n ƒëi s√°ng s·ªõm ƒë·ªÉ tr√°nh ƒë√¥ng; khu√¥n vi√™n r·∫•t ƒë·∫πp ƒë·ªÉ ch·ª•p ·∫£nh.`
    },
    lang_bac: {
      keyword: 'Ho Chi Minh Mausoleum Hanoi',
      intro: `LƒÉng Ch·ªß t·ªãch H·ªì Ch√≠ Minh n·∫±m t·∫°i Qu·∫£ng tr∆∞·ªùng Ba ƒê√¨nh ‚Äì trung t√¢m ch√≠nh tr·ªã c·ªßa Vi·ªát Nam. Khu v·ª±c xung quanh c√≤n c√≥ Ph·ªß Ch·ªß t·ªãch, nh√† s√†n B√°c H·ªì v√† nhi·ªÅu ƒëi·ªÉm tham quan l·ªãch s·ª≠ l√¢n c·∫≠n.`,
      address: `2 H√πng V∆∞∆°ng, Ba ƒê√¨nh, H√† N·ªôi (khu Qu·∫£ng tr∆∞·ªùng Ba ƒê√¨nh)`,
      hours: `Gi·ªù v√†o lƒÉng thay ƒë·ªïi theo m√πa v√† theo ng√†y. Th∆∞·ªùng m·ªü bu·ªïi s√°ng: Th·ª© 3‚Äì5, Th·ª© 7‚ÄìCN; ngh·ªâ Th·ª© 2 & Th·ª© 6.`,
      ticket: `V√†o lƒÉng: mi·ªÖn ph√≠ (tham kh·∫£o). M·ªôt s·ªë khu tham quan l√¢n c·∫≠n c√≥ th·ªÉ c√≥ v√©.`,
      busTips: [
        `N√™n ƒëi bu·ªïi s√°ng s·ªõm (ƒë√∫ng khung gi·ªù m·ªü).`,
        `Trang ph·ª•c l·ªãch s·ª±, kh√¥ng mang h√†nh l√Ω c·ªìng k·ªÅnh.`
      ],
      note: `L∆∞u √Ω: trang ph·ª•c l·ªãch s·ª±; c√≥ khung gi·ªù v√†o lƒÉng theo ng√†y/tu·∫ßn.`
    },
    chua_mot_cot: {
      keyword: 'One Pillar Pagoda Hanoi',
      intro: `Ch√πa M·ªôt C·ªôt l√† c√¥ng tr√¨nh ki·∫øn tr√∫c ƒë·ªôc ƒë√°o v·ªõi h√¨nh d√°ng nh∆∞ b√¥ng sen v∆∞∆°n l√™n tr√™n m·∫∑t n∆∞·ªõc, g·∫Øn v·ªõi l·ªãch s·ª≠ th·ªùi L√Ω. ƒê√¢y l√† m·ªôt trong nh·ªØng bi·ªÉu t∆∞·ª£ng vƒÉn h√≥a ‚Äì t√¢m linh n·ªïi ti·∫øng nh·∫•t c·ªßa H√† N·ªôi.`,
      address: `Khu di t√≠ch, qu·∫≠n Ba ƒê√¨nh, H√† N·ªôi`,
      hours: `07:00‚Äì18:00 h√†ng ng√†y`,
      ticket: `Tham kh·∫£o: ng∆∞·ªùi Vi·ªát mi·ªÖn ph√≠; kh√°ch qu·ªëc t·∫ø ~25.000ƒë`,
      busTips: [
        `C√≥ th·ªÉ k·∫øt h·ª£p tham quan LƒÉng B√°c ‚Äì B·∫£o t√†ng H·ªì Ch√≠ Minh trong c√πng bu·ªïi.`,
        `Xu·ªëng bus g·∫ßn khu Ba ƒê√¨nh, ƒëi b·ªô v√†o c·ªïng khu di t√≠ch.`
      ],
      note: `G·ª£i √Ω: c√≥ th·ªÉ k·∫øt h·ª£p tham quan LƒÉng B√°c ‚Äì B·∫£o t√†ng HCM trong c√πng m·ªôt bu·ªïi.`
    },
    tran_quoc: {
      keyword: 'Tran Quoc Pagoda Hanoi',
      intro: `Ch√πa Tr·∫•n Qu·ªëc l√† ng√¥i ch√πa c·ªï n·ªïi ti·∫øng b√™n H·ªì T√¢y, ƒë∆∞·ª£c xem l√† m·ªôt trong nh·ªØng ng√¥i ch√πa l√¢u ƒë·ªùi nh·∫•t Vi·ªát Nam. Kh√¥ng gian thanh t·ªãnh, th√°p b·∫£o v√† c·∫£nh h·ªì t·∫°o n√™n khung h√¨nh r·∫•t ƒë·∫πp, ƒë·∫∑c bi·ªát l√∫c ho√†ng h√¥n.`,
      address: `46 Thanh Ni√™n, qu·∫≠n T√¢y H·ªì, H√† N·ªôi`,
      hours: `Tham kh·∫£o: 08:00‚Äì16:00 (ng√†y th∆∞·ªùng); m√πng 1 & r·∫±m c√≥ th·ªÉ m·ªü s·ªõm h∆°n`,
      ticket: `Mi·ªÖn ph√≠ (th∆∞·ªùng).`,
      busTips: [
        `ƒêi chi·ªÅu t·ªëi ƒë·ªÉ ng·∫Øm ho√†ng h√¥n H·ªì T√¢y; k·∫øt h·ª£p d·∫°o ƒë∆∞·ªùng Thanh Ni√™n.`,
        `Xu·ªëng bus g·∫ßn ƒë∆∞·ªùng Thanh Ni√™n / Y√™n Ph·ª• r·ªìi ƒëi b·ªô 3‚Äì8 ph√∫t.`
      ],
      note: `G·ª£i √Ω: ƒëi chi·ªÅu t·ªëi ƒë·ªÉ ng·∫Øm ho√†ng h√¥n H·ªì T√¢y; k·∫øt h·ª£p d·∫°o ƒë∆∞·ªùng Thanh Ni√™n.`
    },
    ho_tay: {
      keyword: 'West Lake Hanoi',
      intro: `H·ªì T√¢y l√† h·ªì t·ª± nhi√™n l·ªõn nh·∫•t H√† N·ªôi, n·ªïi ti·∫øng v·ªõi cung ƒë∆∞·ªùng d·∫°o m√°t, qu√°n c√† ph√™ view h·ªì v√† c√°c ƒëi·ªÉm t√¢m linh nh∆∞ Ph·ªß T√¢y H·ªì, ch√πa Tr·∫•n Qu·ªëc. ƒê√¢y l√† khu v·ª±c l√Ω t∆∞·ªüng ƒë·ªÉ th∆∞ gi√£n, ƒë·∫°p xe v√† ng·∫Øm ho√†ng h√¥n.`,
      address: `Qu·∫≠n T√¢y H·ªì, H√† N·ªôi`,
      hours: `Kh√¥ng gi·ªõi h·∫°n (khu v·ª±c c√¥ng c·ªông)`,
      ticket: `Mi·ªÖn ph√≠`,
      busTips: [
        `Ch·ªçn ƒëi·ªÉm xu·ªëng bus g·∫ßn ƒë∆∞·ªùng Thanh Ni√™n / L·∫°c Long Qu√¢n / √Çu C∆° tu·ª≥ n∆°i b·∫°n mu·ªën d·∫°o.`,
        `Khung gi·ªù ƒë·∫πp: 16:30‚Äì18:30.`
      ],
      note: `G·ª£i √Ω: khung gi·ªù ƒë·∫πp l√† 16:30‚Äì18:30; bu·ªïi t·ªëi nhi·ªÅu qu√°n ƒÉn/coffee.`
    },
    hoang_thanh: {
      keyword: 'Imperial Citadel Thang Long',
      intro: `Ho√†ng th√†nh ThƒÉng Long l√† di s·∫£n th·∫ø gi·ªõi UNESCO, l∆∞u gi·ªØ c√°c t·∫ßng vƒÉn h√≥a ‚Äì ki·∫øn tr√∫c t·ª´ th·ªùi L√Ω, Tr·∫ßn, L√™ ƒë·∫øn Nguy·ªÖn. Tham quan t·∫°i ƒë√¢y gi√∫p b·∫°n hi·ªÉu s√¢u h∆°n v·ªÅ l·ªãch s·ª≠ kinh ƒë√¥ ThƒÉng Long qua c√°c khu kh·∫£o c·ªï v√† hi·ªán v·∫≠t.`,
      address: `19C Ho√†ng Di·ªáu, qu·∫≠n Ba ƒê√¨nh, H√† N·ªôi`,
      hours: `08:00‚Äì17:00 h√†ng ng√†y`,
      ticket: `Tham kh·∫£o: 100.000ƒë/l∆∞·ª£t (c√≥ th·ªÉ thay ƒë·ªïi)`,
      busTips: [
        `Xu·ªëng bus g·∫ßn Ho√†ng Di·ªáu / ƒêi·ªán Bi√™n Ph·ªß r·ªìi ƒëi b·ªô v√†o c·ªïng.`,
        `N√™n d√†nh 1‚Äì2 gi·ªù ƒë·ªÉ tham quan tr·ªçn v·∫πn.`
      ],
      note: `G·ª£i √Ω: n√™n d√†nh 1‚Äì2 gi·ªù ƒë·ªÉ tham quan tr·ªçn v·∫πn; mang theo n∆∞·ªõc u·ªëng.`
    },
    nha_tho_lon: {
      keyword: 'St Joseph Cathedral Hanoi',
      intro: `Nh√† th·ªù L·ªõn H√† N·ªôi mang ki·∫øn tr√∫c Gothic ki·ªÉu Ph√°p, l√† ƒëi·ªÉm check‚Äëin n·ªïi ti·∫øng v√† c≈©ng l√† trung t√¢m sinh ho·∫°t t√¥n gi√°o c·ªßa khu v·ª±c. Khu v·ª±c quanh nh√† th·ªù c√≥ nhi·ªÅu qu√°n c√† ph√™, ph·ªë s√°ch v√† kh√¥ng kh√≠ r·∫•t ‚Äúph·ªë‚Äù.`,
      address: `40 Nh√† Chung, qu·∫≠n Ho√†n Ki·∫øm, H√† N·ªôi`,
      hours: `Tham kh·∫£o: T2‚ÄìT7: 08:00‚Äì11:00 & 14:00‚Äì20:00 ‚Ä¢ CN: 07:00‚Äì11:30 & 15:00‚Äì21:00`,
      ticket: `Mi·ªÖn ph√≠`,
      busTips: [
        `Xu·ªëng bus ·ªü khu B·ªù H·ªì/Tr√†ng Thi r·ªìi ƒëi b·ªô 5‚Äì12 ph√∫t.`,
        `Bu·ªïi t·ªëi l√™n ƒë√®n ƒë·∫πp; l∆∞u √Ω gi·ªù l·ªÖ n·∫øu mu·ªën tham d·ª±.`
      ],
      note: `G·ª£i √Ω: bu·ªïi t·ªëi l√™n ƒë√®n ƒë·∫πp; l∆∞u √Ω gi·ªù l·ªÖ n·∫øu mu·ªën tham d·ª±.`
    },
    nha_hat_lon: {
      keyword: 'Hanoi Opera House',
      intro: `Nh√† h√°t L·ªõn H√† N·ªôi l√† c√¥ng tr√¨nh ki·∫øn tr√∫c Ph√°p ti√™u bi·ªÉu, n·∫±m g·∫ßn ph·ªë Tr√†ng Ti·ªÅn v√† khu trung t√¢m. ƒê√¢y l√† ƒëi·ªÉm ch·ª•p ·∫£nh ƒë·∫πp, ƒë·ªìng th·ªùi th∆∞·ªùng xuy√™n c√≥ c√°c ch∆∞∆°ng tr√¨nh bi·ªÉu di·ªÖn ngh·ªá thu·∫≠t.`,
      address: `1 Tr√†ng Ti·ªÅn, qu·∫≠n Ho√†n Ki·∫øm, H√† N·ªôi`,
      hours: `Tham quan theo tour/s·ª± ki·ªán (tu·ª≥ l·ªãch).`,
      ticket: `Tu·ª≥ ch∆∞∆°ng tr√¨nh/ tour (tham kh·∫£o).`,
      busTips: [
        `Xu·ªëng bus ·ªü khu Tr√†ng Ti·ªÅn/Tr·∫ßn H∆∞ng ƒê·∫°o r·ªìi ƒëi b·ªô 2‚Äì8 ph√∫t.`,
        `C√≥ th·ªÉ k·∫øt h·ª£p d·∫°o ph·ªë Tr√†ng Ti·ªÅn ‚Äì H·ªì G∆∞∆°m.`
      ],
      note: `G·ª£i √Ω: ch·ª•p ·∫£nh ƒë·∫πp nh·∫•t v√†o chi·ªÅu mu·ªôn/ban ƒë√™m khi b·∫≠t ƒë√®n.`
    },
    cau_long_bien: {
      keyword: 'Long Bien Bridge Hanoi',
      intro: `C·∫ßu Long Bi√™n l√† c√¢y c·∫ßu l·ªãch s·ª≠ b·∫Øc qua s√¥ng H·ªìng, g·∫Øn v·ªõi nhi·ªÅu d·∫•u m·ªëc c·ªßa H√† N·ªôi. ƒê√¢y l√† ƒëi·ªÉm check‚Äëin r·∫•t ‚Äúch·∫•t‚Äù, nh·∫•t l√† l√∫c b√¨nh minh/ho√†ng h√¥n v·ªõi ƒë∆∞·ªùng ray v√† d√≤ng s√¥ng r·ªông.`,
      address: `K·∫øt n·ªëi qu·∫≠n Ho√†n Ki·∫øm ‚Äì Long Bi√™n, H√† N·ªôi`,
      hours: `Kh√¥ng gi·ªõi h·∫°n (ƒëi l·∫°i b√¨nh th∆∞·ªùng).`,
      ticket: `Mi·ªÖn ph√≠`,
      busTips: [
        `Xu·ªëng bus g·∫ßn ga Long Bi√™n/ƒë·∫ßu c·∫ßu r·ªìi ƒëi b·ªô l√™n c·∫ßu.`,
        `C·∫©n th·∫≠n khi ch·ª•p ·∫£nh, tr√°nh khu v·ª±c nguy hi·ªÉm g·∫ßn ƒë∆∞·ªùng ray.`
      ],
      note: `G·ª£i √Ω: ƒëi s√°ng s·ªõm ho·∫∑c ho√†ng h√¥n ƒë·ªÉ c√≥ √°nh s√°ng ƒë·∫πp.`
    },
    bao_tang_dth: {
      keyword: 'Vietnam Museum of Ethnology Hanoi',
      intro: `B·∫£o t√†ng D√¢n t·ªôc h·ªçc Vi·ªát Nam tr∆∞ng b√†y phong ph√∫ v·ªÅ vƒÉn ho√° c·ªßa 54 d√¢n t·ªôc, c√≥ khu tr∆∞ng b√†y ngo√†i tr·ªùi r·∫•t th√∫ v·ªã. ƒê√¢y l√† n∆°i ph√π h·ª£p n·∫øu b·∫°n mu·ªën tham quan ‚Äúc√≥ chi·ªÅu s√¢u‚Äù v√† ch·ª•p ·∫£nh ki·∫øn tr√∫c.`,
      address: `Nguy·ªÖn VƒÉn Huy√™n, qu·∫≠n C·∫ßu Gi·∫•y, H√† N·ªôi`,
      hours: `08:30‚Äì17:30 (ƒë√≥ng c·ª≠a Th·ª© 2)`,
      ticket: `Tham kh·∫£o: 40.000ƒë (c√≥ th·ªÉ thay ƒë·ªïi)`,
      busTips: [
        `Xu·ªëng bus g·∫ßn ƒë∆∞·ªùng Nguy·ªÖn VƒÉn Huy√™n / C·∫ßu Gi·∫•y r·ªìi ƒëi b·ªô v√†o.`,
        `N√™n ƒëi bu·ªïi s√°ng ƒë·ªÉ c√≥ th·ªùi gian tham quan c·∫£ khu ngo√†i tr·ªùi.`
      ],
      note: `G·ª£i √Ω: d√†nh 2‚Äì3 gi·ªù ƒë·ªÉ xem k·ªπ; khu ngo√†i tr·ªùi r·∫•t ƒë√°ng ƒëi.`
    },
    lotte: {
      keyword: 'Lotte Center Hanoi Sky Deck',
      intro: `Lotte Center Hanoi l√† to√† nh√† cao t·∫ßng n·ªïi b·∫≠t, c√≥ ƒë√†i quan s√°t (Sky Deck) cho g√≥c nh√¨n to√†n c·∫£nh th√†nh ph·ªë. Ph√π h·ª£p ƒë·ªÉ ng·∫Øm ho√†ng h√¥n v√† ch·ª•p ·∫£nh skyline H√† N·ªôi.`,
      address: `54 Li·ªÖu Giai, qu·∫≠n Ba ƒê√¨nh, H√† N·ªôi`,
      hours: `Tham kh·∫£o: 09:00‚Äì23:00 (tu·ª≥ khu v·ª±c)`,
      ticket: `Sky Deck: tu·ª≥ th·ªùi ƒëi·ªÉm (tham kh·∫£o).`,
      busTips: [
        `Xu·ªëng bus tr√™n ƒë∆∞·ªùng Li·ªÖu Giai/ƒê√†o T·∫•n, ƒëi b·ªô 2‚Äì6 ph√∫t.`,
        `N√™n ƒëi chi·ªÅu mu·ªôn ƒë·ªÉ ng·∫Øm ho√†ng h√¥n v√† th√†nh ph·ªë l√™n ƒë√®n.`
      ],
      note: `G·ª£i √Ω: chi·ªÅu mu·ªôn l√† ƒë·∫πp nh·∫•t; c√≥ th·ªÉ ƒë·∫∑t v√© tr∆∞·ªõc n·∫øu ƒë√¥ng.`
    },
    ben_xe_my_dinh: {
      keyword: 'My Dinh Bus Station Hanoi',
      intro: `B·∫øn xe M·ªπ ƒê√¨nh l√† m·ªôt trung t√¢m trung chuy·ªÉn l·ªõn c·ªßa H√† N·ªôi, thu·∫≠n ti·ªán n·∫øu b·∫°n c·∫ßn b·∫Øt xe li√™n t·ªânh ho·∫∑c k·∫øt n·ªëi c√°c tuy·∫øn bus n·ªôi ƒë√¥.`,
      address: `20 Ph·∫°m H√πng, Nam T·ª´ Li√™m, H√† N·ªôi`,
      hours: `Ho·∫°t ƒë·ªông c·∫£ ng√†y (tu·ª≥ qu·∫ßy/nh√† xe).`,
      ticket: `Tu·ª≥ tuy·∫øn/nh√† xe`,
      busTips: [
        `Khu v·ª±c Ph·∫°m H√πng th∆∞·ªùng ƒë√¥ng gi·ªù cao ƒëi·ªÉm; n√™n ƒëi s·ªõm.`,
        `Ki·ªÉm tra ƒëi·ªÉm d·ª´ng c·ª• th·ªÉ c·ªßa tuy·∫øn bus g·∫ßn c·ªïng b·∫°n mu·ªën v√†o.`
      ],
      note: `G·ª£i √Ω: ƒë·∫øn s·ªõm ƒë·ªÉ tr√°nh ƒë√¥ng, nh·∫•t l√† d·ªãp l·ªÖ/t·∫øt.`
    }
  };

  // ===== Modal controller =====
  const poiModal = document.getElementById('poiModal');
  const poiBackdrop = document.getElementById('poiBackdrop');
  const poiModalBack = document.getElementById('poiModalBack');
  const poiModalClose = document.getElementById('poiModalClose');
  const poiModalTitle = document.getElementById('poiModalTitle');
  const poiModalIntro = document.getElementById('poiModalIntro');
  const poiMainImg = document.getElementById('poiMainImg');
  const poiThumbs = document.getElementById('poiThumbs');
  const poiPrev = document.getElementById('poiPrev');
  const poiNext = document.getElementById('poiNext');
  const poiCount = document.getElementById('poiCount');
  const poiExtraNote = document.getElementById('poiExtraNote');
  const poiGallery = document.getElementById('poiGallery');

  let currentPoi = null;
  let poiImages = [];
  let poiIdx = 0;
  let poiLoadingToken = 0;

  function renderPoiGallery(){
    if (!poiImages.length) return;
    poiIdx = Math.max(0, Math.min(poiIdx, poiImages.length - 1));
    if (poiGallery) poiGallery.classList.remove('portrait');

    const src = poiImages[poiIdx];
    poiMainImg.onerror = () => {
      poiMainImg.onerror = null;
      poiMainImg.src = svgPlaceholder(currentPoi?.name || 'POI', 'Kh√¥ng t·∫£i ƒë∆∞·ª£c ·∫£nh');
    };
    poiMainImg.src = src;

    // T·ª± ƒë·ªông t·ªëi ∆∞u hi·ªÉn th·ªã: ·∫£nh d·ªçc cho ph√©p khung cao h∆°n, ·∫£nh ngang/square gi·ªØ g·ªçn
    const applyFit = () => {
      const nw = poiMainImg.naturalWidth || 0;
      const nh = poiMainImg.naturalHeight || 0;
      if (nw && nh && poiGallery){
        const portrait = (nh / nw) > 1.08;
        poiGallery.classList.toggle('portrait', portrait);
      }
    };
    poiMainImg.onload = applyFit;
    if (poiMainImg.complete) setTimeout(applyFit, 0);

    if (poiCount) poiCount.textContent = `${poiIdx + 1}/${poiImages.length}`;

    if (poiThumbs){
      poiThumbs.innerHTML = poiImages.map((src, i) => {
        const cls = i === poiIdx ? "poi-thumb active" : "poi-thumb";
        return `<img class="${cls}" data-i="${i}" src="${src}" alt="·∫¢nh ${i+1}">`;
      }).join("");

      poiThumbs.querySelectorAll('img[data-i]').forEach(img => {
        img.onerror = () => {
          img.onerror = null;
          img.src = svgPlaceholder(currentPoi?.name || 'POI', 'Kh√¥ng t·∫£i ƒë∆∞·ª£c ·∫£nh');
        };
        img.addEventListener('click', () => {
          poiIdx = Number(img.getAttribute('data-i') || 0);
          renderPoiGallery();
        });
      });
    }
  }

  function renderPoiMetaHtml(d, busState){
    const address = d.address ? `<div><b>ƒê·ªãa ch·ªâ:</b> ${escapeHtml(d.address)}</div>` : '';
    const hours = d.hours ? `<div><b>Gi·ªù m·ªü c·ª≠a:</b> ${escapeHtml(d.hours)}</div>` : '';
    const ticket = d.ticket ? `<div><b>Gi√° v√©:</b> ${escapeHtml(d.ticket)}</div>` : '';

    const tips = (d.busTips && d.busTips.length)
      ? `<div style="margin-top:10px"><b>Tips ƒëi bus:</b><ul style="margin:8px 0 0 18px">${d.busTips.map(x => `<li>${escapeHtml(x)}</li>`).join('')}</ul></div>`
      : '';

    let dyn = '';
    if (busState?.loading){
      dyn = `<div style="margin-top:10px; opacity:.8"><b>G·ª£i √Ω tr·∫°m g·∫ßn nh·∫•t:</b> ƒêang t·∫£i‚Ä¶</div>`;
    } else if (busState?.error){
      dyn = `<div style="margin-top:10px; opacity:.85"><b>G·ª£i √Ω tr·∫°m g·∫ßn nh·∫•t:</b> Kh√¥ng t·∫£i ƒë∆∞·ª£c.</div>`;
    } else if (busState?.stop){
      const s = busState.stop;
      const routes = (busState.routes || []).map(r => (r.route_short_name || r.route_short || r.route_id)).filter(Boolean);
      dyn = `
        <div style="margin-top:10px">
          <b>Tr·∫°m g·∫ßn nh·∫•t:</b> ${escapeHtml(s.stop_name || s.stop_id)} ‚Ä¢ ${fmtMeters(s.distance_m)}
          ${routes.length ? `<div style="margin-top:6px"><b>Tuy·∫øn qua tr·∫°m:</b> ${escapeHtml(routes.slice(0, 14).join(', '))}${routes.length>14?'‚Ä¶':''}</div>` : ''}
        </div>
      `.trim();
    }

    const note = d.note ? `<div style="margin-top:10px; opacity:.9">${escapeHtml(d.note)}</div>` : '';

    return `
      <div style="display:flex; flex-direction:column; gap:6px">
        ${address}
        ${hours}
        ${ticket}
        ${dyn}
        ${tips}
        ${note}
      </div>
    `.trim();
  }

  async function hydratePoiBusInfo(poi){
    const d = POI_DETAILS[poi.id] || {};
    try{
      const ns = await postJSON(`${API_BASE}/nearest-stops`, { lat: poi.lat, lon: poi.lon, limit: 1, radius_m: 1500 });
      const stop = (ns.stops || [])[0];
      if (!stop){
        if (poiExtraNote) poiExtraNote.innerHTML = renderPoiMetaHtml(d, { error: true });
        return;
      }
      let routes = [];
      try {
        const rr = await postJSON(`${API_BASE}/stop-routes`, { stop_id: stop.stop_id, limit: 50 });
        routes = rr.routes || [];
      } catch { /* ignore */ }

      if (poiExtraNote) poiExtraNote.innerHTML = renderPoiMetaHtml(d, { stop, routes });
    } catch {
      if (poiExtraNote) poiExtraNote.innerHTML = renderPoiMetaHtml(d, { error: true });
    }
  }

  function openPoiModal(poi){
    currentPoi = poi;
    const token = ++poiLoadingToken;
    const d = POI_DETAILS[poi.id] || {};

    if (poiModalTitle) poiModalTitle.textContent = poi.name;
    if (poiModalIntro) poiModalIntro.textContent = d.intro || poi.note || '‚Äî';

    // Meta + tips (k√®m bus info ƒë·ªông theo stop g·∫ßn nh·∫•t)
    if (poiExtraNote){
      poiExtraNote.innerHTML = renderPoiMetaHtml(d, { loading: true });
    }

    // Hi·ªÉn th·ªã placeholder tr∆∞·ªõc, r·ªìi t·∫£i ·∫£nh online (c√≥ cache)
    poiImages = [svgPlaceholder(poi.name || 'POI', 'ƒêang t·∫£i ·∫£nh‚Ä¶')];
    poiIdx = 0;
    renderPoiGallery();

    poiModal?.classList.add('show');
    poiModal?.setAttribute('aria-hidden','false');

    (async () => {
      const imgs = await getPoiImages(poi);
      if (token !== poiLoadingToken) return; // modal ƒë√£ chuy·ªÉn POI kh√°c
      poiImages = imgs && imgs.length ? imgs : [svgPlaceholder(poi.name || 'POI', 'Kh√¥ng t·∫£i ƒë∆∞·ª£c ·∫£nh')];
      poiIdx = 0;
      renderPoiGallery();
    })();

    hydratePoiBusInfo(poi);
  }

  function closePoiModal(){
    poiModal?.classList.remove('show');
    poiModal?.setAttribute('aria-hidden','true');
  }

  poiBackdrop?.addEventListener('click', closePoiModal);
  poiModalClose?.addEventListener('click', closePoiModal);
  // Quay l·∫°i danh s√°ch ƒëi·ªÉm du l·ªãch
  poiModalBack?.addEventListener('click', () => {
    closePoiModal();
    // ƒë·∫£m b·∫£o layer POI c√≥ s·∫µn v√† m·ªü l·∫°i danh s√°ch
    try { renderPOIsOnMap(); } catch {}
    try { openPOIList(); } catch {}
  });
  poiPrev?.addEventListener('click', () => {
    if (!poiImages.length) return;
    poiIdx = (poiIdx - 1 + poiImages.length) % poiImages.length;
    renderPoiGallery();
  });
  poiNext?.addEventListener('click', () => {
    if (!poiImages.length) return;
    poiIdx = (poiIdx + 1) % poiImages.length;
    renderPoiGallery();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === "Escape" && poiModal?.classList.contains('show')) closePoiModal();
  });


  // ===== Map =====
  const map = L.map('map', { zoomControl: false }).setView([21.0285, 105.8542], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
  L.control.zoom({ position: 'bottomleft' }).addTo(map);

  // ===== State =====
  let gpsLatLng = null;
  let startLatLng = null;
  let endLatLng = null;

// Chu·∫©n ho√° lat/lng: h·ªó tr·ª£ d·∫°ng [lat,lng], {lat,lng}, {lat,lon}
function normalizeLatLng(ll){
  if (!ll) return null;
  if (Array.isArray(ll) && ll.length >= 2){
    const lat = parseFloat(ll[0]);
    const lng = parseFloat(ll[1]);
    if (Number.isFinite(lat) && Number.isFinite(lng)) return { lat, lng };
    return null;
  }
  if (typeof ll === 'object'){
    const lat = parseFloat(ll.lat);
    const lngRaw = (ll.lng ?? ll.lon);
    const lng = parseFloat(lngRaw);
    if (Number.isFinite(lat) && Number.isFinite(lng)) return { lat, lng };
    return null;
  }
  return null;
}

  let endStopId = null;

  let isPickingStart = false;
  let isPickingDest = false;

  let gpsMarker = null;
  let startMarker = null;
  let endMarker = null;
  let poiMarker = null;

  let stopsEnabled = false;
  let stopsLayer = L.layerGroup().addTo(map);
  let poiLayer = L.layerGroup().addTo(map);

  let routeLayers = [];
  let transferMarkers = [];

  let lastPlan = null;
  let stopsIndex = null; // stop_id -> {name, lat, lon}

  // ===== UI refs =====
  const toastEl = document.getElementById('toast');

  const sheet = document.getElementById('sheet');
  const handle = document.getElementById('handle');
  const sheetTitle = document.getElementById('sheetTitle');
  const sheetSubtitle = document.getElementById('sheetSubtitle');
  const sheetBody = document.getElementById('sheetBody');
  const btnExpand = document.getElementById('btnExpand');
  const btnCloseSheet = document.getElementById('btnCloseSheet');

  const btnGPS = document.getElementById('btnGPS');
  const btnPickStart = document.getElementById('btnPickStart');
  const btnPickDest = document.getElementById('btnPickDest');
  const btnToggleStops = document.getElementById('btnToggleStops');
  const btnNearest = document.getElementById('btnNearest');
  const btnClear = document.getElementById('btnClear');

  const btnToggleControls = document.getElementById('btnToggleControls');
  const fabGroup = document.getElementById('fabGroup');

  const placeInput = document.getElementById('placeInput');
  const btnPlaceGo = document.getElementById('btnPlaceGo');
  const btnPOIs = document.getElementById('btnPOIs');

  const subsheet = document.getElementById('subsheet');
  const subBack = document.getElementById('subBack');
  const subTitle = document.getElementById('subTitle');
  const subHint = document.getElementById('subHint');
  const subBody = document.getElementById('subBody');

  // ===== Helpers =====
  function showToast(msg, type="") {
    toastEl.className = "toast show " + (type || "");
    toastEl.innerHTML = msg;
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toastEl.classList.remove('show'), 2600);
  }

  function setFabActive(el, active){
    el.classList.toggle('active', !!active);
  }

  // HTML escape ƒë·ªÉ render text an to√†n trong innerHTML (tr√°nh l·ªói khi c√≥ k√Ω t·ª± ƒë·∫∑c bi·ªát)
  function escapeHtml(input){
    return String(input ?? '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  // Helper POST JSON theo full URL (d√πng cho c√°c call ki·ªÉu `${API_BASE}/...`)
  async function postJSON(url, body){
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body || {})
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      const msg = (data && (data.error || data.message)) ? (data.error || data.message) : `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }


  // Toggle visibility of the right-side function buttons
  let controlsHidden = false;
  const controlsLabelEl = btnToggleControls ? btnToggleControls.querySelector('.label') : null;
  const controlsIconEl  = btnToggleControls ? btnToggleControls.querySelector('.ico') : null;

  function applyControlsHidden(hidden){
    controlsHidden = !!hidden;
    if (fabGroup) fabGroup.classList.toggle('hidden', controlsHidden);
    if (controlsLabelEl) controlsLabelEl.textContent = controlsHidden ? "Hi·ªán ph√≠m ch·ª©c nƒÉng" : "·∫®n ph√≠m ch·ª©c nƒÉng";
    if (controlsIconEl) controlsIconEl.textContent = controlsHidden ? "‚ò∞" : "‚úï";
    if (btnToggleControls) setFabActive(btnToggleControls, !controlsHidden);
    try{ localStorage.setItem('busmaps_controls_hidden', controlsHidden ? '1' : '0'); }catch(_e){}
  }

  // Restore previous state
  try{ controlsHidden = localStorage.getItem('busmaps_controls_hidden') === '1'; }
  catch(_e){ controlsHidden = false; }
  applyControlsHidden(controlsHidden);

  // ===== Sheet visibility (only show when a route exists) =====
  let sheetHasRoute = false;

  function setSheetVisible(visible){
    sheetHasRoute = !!visible;
    sheet.classList.toggle('hidden', !sheetHasRoute);
    if (!sheetHasRoute) sheet.classList.remove('expanded');
  }

  // Hide on startup until a route is drawn
  setSheetVisible(false);


  function setSheetState(expanded){
    sheet.classList.toggle('expanded', !!expanded);
  }

  function openSubSheet(title, hint, html){
    subTitle.textContent = title;
    subHint.textContent = hint || "";
    subBody.innerHTML = html || "";
    subsheet.classList.add('open');
    subsheet.setAttribute('aria-hidden','false');
  }
  function closeSubSheet(){
    subsheet.classList.remove('open');
    subsheet.setAttribute('aria-hidden','true');
  }

  function fmtMeters(m) {
    if (m == null || isNaN(m)) return "‚Äî";
    if (m < 1000) return `${Math.round(m)} m`;
    return `${(m/1000).toFixed(2)} km`;
  }

  function nowHHMM() {
    const d = new Date();
    return String(d.getHours()).padStart(2,'0') + ":" + String(d.getMinutes()).padStart(2,'0');
  }

  function addMinutesHHMM(hhmm, mins) {
    const [hh, mm] = hhmm.split(':').map(Number);
    const d = new Date();
    d.setHours(hh, mm, 0, 0);
    d.setMinutes(d.getMinutes() + mins);
    return String(d.getHours()).padStart(2,'0') + ":" + String(d.getMinutes()).padStart(2,'0');
  }

  // ETA estimate (no realtime)
  const WALK_SPEED_MPS = 1.25; // ~4.5 km/h
  const BUS_SPEED_MPS  = 5.5;  // ~19.8 km/h
  const WAIT_INITIAL_BUS_SEC = 180;
  const WAIT_TRANSFER_SEC = 120;
  const BOARDING_SEC = 30;

  function estimateEtaMinutes(summary){
    const total = Number(summary?.distance ?? summary?.distance_m ?? 0);
    const walk = Number(summary?.walking_distance ?? summary?.walking_distance_m ?? 0);
    const transfers = Number(summary?.transfers ?? 0);

    const bus = Math.max(0, total - walk);
    const sec = (walk / WALK_SPEED_MPS) + (bus / BUS_SPEED_MPS)
      + WAIT_INITIAL_BUS_SEC + transfers * WAIT_TRANSFER_SEC + BOARDING_SEC;
    return Math.max(1, Math.round(sec / 60));
  }

  async function apiPost(path, body){
    const res = await fetch(`${API_BASE}${path}`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body || {})
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      const msg = data && (data.error || data.message) ? (data.error || data.message) : `L·ªói ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  async function apiGet(path){
    const res = await fetch(`${API_BASE}${path}`);
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      const msg = data && (data.error || data.message) ? (data.error || data.message) : `L·ªói ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  async function ensureStopsIndex(){
    if (stopsIndex) return stopsIndex;
    const data = await apiGet('/stops-all');
    const idx = {};
    (data.stops || []).forEach(s => {
      idx[String(s.stop_id)] = { name: s.stop_name, lat: Number(s.stop_lat), lon: Number(s.stop_lon) };
    });
    stopsIndex = idx;
    return stopsIndex;
  }

  function setStart(latLng, label){
  const ll = normalizeLatLng(latLng);
  if (!ll){
    showToast("Kh√¥ng l·∫•y ƒë∆∞·ª£c to·∫° ƒë·ªô ƒëi·ªÉm xu·∫•t ph√°t.", "warn");
    return;
  }
  startLatLng = ll;
  startLabel = label || `Start (${ll.lat.toFixed(5)}, ${ll.lng.toFixed(5)})`;

  if (startMarker) map.removeLayer(startMarker);
  startMarker = L.marker([ll.lat, ll.lng], { icon: startIcon }).addTo(map);
  startMarker.bindPopup(`<b>ƒêi·ªÉm xu·∫•t ph√°t</b><br>${escapeHtml(startLabel)}`).openPopup();

  updateRouteBadge();
}

  function setDestination(latLng, label, stopId=null){
  const ll = normalizeLatLng(latLng);
  if (!ll){
    showToast("Kh√¥ng l·∫•y ƒë∆∞·ª£c to·∫° ƒë·ªô ƒëi·ªÉm ƒë·∫øn.", "warn");
    return;
  }
  endLatLng = ll;
  endLabel = label || `End (${ll.lat.toFixed(5)}, ${ll.lng.toFixed(5)})`;
  endStopId = stopId || null;

  if (endMarker) map.removeLayer(endMarker);
  endMarker = L.marker([ll.lat, ll.lng], { icon: endIcon }).addTo(map);
  endMarker.bindPopup(`<b>ƒêi·ªÉm ƒë·∫øn</b><br>${escapeHtml(endLabel)}`).openPopup();

  updateRouteBadge();
}

  function clearPicking(){
    isPickingStart = false;
    isPickingDest = false;
    setFabActive(btnPickStart, false);
    setFabActive(btnPickDest, false);
    map.getContainer().style.cursor = "";
  }

  function clearRoute(removeDestination=false, silent=false){
    routeLayers.forEach(l => map.removeLayer(l));
    transferMarkers.forEach(m => map.removeLayer(m));
    routeLayers = [];
    transferMarkers = [];
    lastPlan = null;

    // Optionally remove destination marker as well
    if (removeDestination){
      endLatLng = null;
      endStopId = null;
      if (endMarker){
        map.removeLayer(endMarker);
        endMarker = null;
      }
    }

    sheetTitle.textContent = "L·ªô tr√¨nh";
    sheetSubtitle.textContent = "Ch·ªçn ƒëi·ªÉm ƒë·∫øn ƒë·ªÉ xem l·ªô tr√¨nh";
    sheetBody.innerHTML = "";

    // Hide the sheet when there is no route
    setSheetVisible(false);

    if (!silent) showToast("ƒê√£ xo√° l·ªô tr√¨nh", "ok");
  }


  function decodePath(path){
    // backend typically returns path as [[lat,lon],...]
    if (!path) return [];
    if (Array.isArray(path) && path.length && Array.isArray(path[0])) {
      return path.map(p => [Number(p[0]), Number(p[1])]);
    }
    return [];
  }

  function drawPlan(plan){

    // ===== Style tuy·∫øn (m√†u kh√°c nhau theo tuy·∫øn xe) =====
    const ROUTE_COLORS = [
      "#5aa9ff", "#37d67a", "#f6c343", "#ff7a45", "#a66bff",
      "#29d3c4", "#ff4d4f", "#8fd14f", "#ff5bbd", "#7aa6ff",
      "#c9a227", "#2dd4bf"
    ];

    function hashStringToInt(str){
      let h = 0;
      for (let i = 0; i < str.length; i++){
        h = (h * 31 + str.charCodeAt(i)) >>> 0;
      }
      return h;
    }

    function colorForRoute(seg){
      const key = String(seg.route_id || seg.route_short_name || seg.route_name || seg.route_long_name || "BUS");
      const idx = hashStringToInt(key) % ROUTE_COLORS.length;
      return ROUTE_COLORS[idx];
    }
    clearRoute(false, true);
    lastPlan = plan;

    const summary = plan.summary || {};
    const segments = plan.segments || [];

    // Draw segment polylines
    let allPts = [];
    segments.forEach((seg, i) => {
      const pts = decodePath(seg.path || seg.map_path || seg.shape || seg.polyline_points);
      if (pts.length) {
        const mode = String(seg.mode || "").toLowerCase();
        const stype = String(seg.type || '').toLowerCase();
        const isWalk = mode.includes('walk') || stype.includes('walk') || seg.route_id === 'WALK' || seg.route_short_name === 'WALK' || seg.route_id === 'walk_transfer';
        const color = isWalk ? "#cfd8e3" : colorForRoute(seg);

        // N√©t ƒë·ª©t cho ƒëo·∫°n ƒëi b·ªô, n√©t li·ªÅn cho xe bu√Ωt
        const polyOpts = {
          color,
          weight: isWalk ? 5 : 6,
          opacity: 0.95,
          lineCap: "round",
          lineJoin: "round",
          dashArray: isWalk ? "8 10" : null
        };

        // V·∫Ω 1 "vi·ªÅn" m·ªèng ph√≠a d∆∞·ªõi ƒë·ªÉ nh√¨n r√µ tr√™n n·ªÅn map
        const outline = L.polyline(pts, {
          color: "rgba(0,0,0,0.35)",
          weight: (isWalk ? 7 : 8),
          opacity: 0.8,
          lineCap: "round",
          lineJoin: "round",
          dashArray: isWalk ? "10 12" : null
        }).addTo(map);
        routeLayers.push(outline);

        const pl = L.polyline(pts, polyOpts).addTo(map);
        routeLayers.push(pl);
        allPts = allPts.concat(pts);
      }
      // transfer marker at segment start (except first)
      if (i > 0 && pts.length) {
        const m = L.circleMarker(pts[0], { radius: 6, weight: 2, opacity: 0.9, fillOpacity: 0.9 }).addTo(map);
        transferMarkers.push(m);
      }
    });

    if (allPts.length) {
      const bounds = L.latLngBounds(allPts);
      map.fitBounds(bounds.pad(0.15));
    }

    // Bottom sheet content
    const depart = nowHHMM();
    const etaMin = estimateEtaMinutes(summary);
    const arrive = addMinutesHHMM(depart, etaMin);

    sheetTitle.textContent = "L·ªô tr√¨nh";
    sheetSubtitle.textContent = `Gi·ªù xu·∫•t ph√°t ${depart} ‚Ä¢ D·ª± ki·∫øn ƒë·∫øn ${arrive} (sau ${etaMin} ph√∫t)`;

    const transfers = Number(summary.transfers ?? 0);
    const totalDist = Number(summary.distance ?? summary.distance_m ?? 0);
    const walkDist = Number(summary.walking_distance ?? summary.walking_distance_m ?? 0);

    let html = `
      <div class="card">
        <div class="row">
          <div class="badge">üïí Xu·∫•t ph√°t: <b>${depart}</b></div>
          <div class="badge">‚è≥ ETA: <b>${etaMin} ph√∫t</b></div>
          <div class="badge">üèÅ ƒê·∫øn: <b>${arrive}</b></div>
        </div>
        <div style="height:10px"></div>
        <div class="row">
          <div><div class="k">T·ªïng qu√£ng ƒë∆∞·ªùng</div><div class="v">${fmtMeters(totalDist)}</div></div>
          <div><div class="k">ƒêi b·ªô</div><div class="v">${fmtMeters(walkDist)}</div></div>
          <div><div class="k">ƒê·ªïi tuy·∫øn</div><div class="v">${transfers}</div></div>
        </div>
        <button class="btn danger" id="btnClearInSheet">Xo√° l·ªô tr√¨nh</button>
      </div>
      <div class="card">
        <div class="k">Chi ti·∫øt ch·∫∑ng</div>
    `;

    segments.forEach((seg, idx) => {
      const mode = String(seg.mode || "").toLowerCase();
      const isWalk = mode.includes("walk") || seg.route_id === "WALK" || seg.route_short_name === "WALK";
      const title = isWalk ? "üö∂ ƒêi b·ªô" : `üöå ${seg.route_name || seg.route_short_name || "Xe bu√Ωt"}`;
      const from = seg.from || "ƒêi·ªÉm A";
      const to = seg.to || "ƒêi·ªÉm B";
      const dist = Number(seg.distance ?? 0);

      html += `
        <div class="seg">
          <h4>${title}</h4>
          <p><b>${from}</b> ‚Üí <b>${to}</b></p>
          <p>Qu√£ng ƒë∆∞·ªùng: ${fmtMeters(dist)} ‚Ä¢ S·ªë tr·∫°m: ${seg.stops_count ?? "‚Äî"}</p>
          <div class="seg-actions">
            <div class="mini" data-action="focus" data-index="${idx}">Xem tr√™n b·∫£n ƒë·ªì</div>
            <div class="mini" data-action="stops" data-index="${idx}">Danh s√°ch tr·∫°m</div>
          </div>
        </div>
      `;
    });

    html += `</div>`;

    sheetBody.innerHTML = html;

    // Show the route sheet now that we have a route
    setSheetVisible(true);
    setSheetState(false);

    document.getElementById('btnClearInSheet')?.addEventListener('click', () => clearRoute(true));

    // segment actions
    sheetBody.querySelectorAll('[data-action="focus"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = Number(btn.getAttribute('data-index'));
        const seg = segments[idx];
        const pts = decodePath(seg.path);
        if (pts.length) map.fitBounds(L.latLngBounds(pts).pad(0.2));
      });
    });

    sheetBody.querySelectorAll('[data-action="stops"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const idx = Number(btn.getAttribute('data-index'));
        const seg = segments[idx] || {};
        const stopIds = seg.stop_ids || [];
        const stopNames = seg.stop_names || [];
        if (!stopIds.length && !stopNames.length) {
          showToast("Ch·∫∑ng n√†y kh√¥ng c√≥ danh s√°ch tr·∫°m.", "warn");
          return;
        }
        await ensureStopsIndex().catch(() => {});
        const items = (stopIds.length ? stopIds : stopNames).map((x, i) => {
          const sid = stopIds[i] ? String(stopIds[i]) : null;
          const name = stopNames[i] || (sid && stopsIndex?.[sid]?.name) || String(x);
          const coord = sid && stopsIndex?.[sid] ? `${stopsIndex[sid].lat.toFixed(5)}, ${stopsIndex[sid].lon.toFixed(5)}` : "";
          const meta = coord ? `T·ªça ƒë·ªô: ${coord}` : (sid ? `M√£ tr·∫°m: ${sid}` : "");
          return `<div class="list-item" data-stopid="${sid || ""}" data-lat="${sid && stopsIndex?.[sid] ? stopsIndex[sid].lat : ""}" data-lon="${sid && stopsIndex?.[sid] ? stopsIndex[sid].lon : ""}">
                    <div class="name">${name}</div>
                    <div class="meta">${meta}</div>
                  </div>`;
        }).join("");

        openSubSheet("Danh s√°ch tr·∫°m", "Ch·∫°m 1 tr·∫°m ƒë·ªÉ ph√≥ng b·∫£n ƒë·ªì t·ªõi v·ªã tr√≠ ƒë√≥", items);

        // click -> focus
        subBody.querySelectorAll('.list-item').forEach(el => {
          el.addEventListener('click', () => {
            const lat = Number(el.getAttribute('data-lat'));
            const lon = Number(el.getAttribute('data-lon'));
            if (!isFinite(lat) || !isFinite(lon)) {
              showToast("Kh√¥ng c√≥ t·ªça ƒë·ªô tr·∫°m trong d·ªØ li·ªáu.", "warn");
              return;
            }
            map.setView([lat, lon], Math.max(map.getZoom(), 16));
            closeSubSheet();
          });
        });
      });
    });

    setSheetState(true);
  }

  async function findRoute(){
    if (!startLatLng) {
      showToast("Vui l√≤ng ch·ªçn ƒëi·ªÉm xu·∫•t ph√°t ho·∫∑c l·∫•y v·ªã tr√≠ c·ªßa b·∫°n.", "warn");
      return;
    }
    if (!endLatLng) {
      showToast("Vui l√≤ng ch·ªçn ƒëi·ªÉm ƒë·∫øn.", "warn");
      return;
    }

    const body = {
      start: { lat: startLatLng.lat, lon: startLatLng.lng },
      end: { lat: endLatLng.lat, lon: endLatLng.lng }
    };
    if (endStopId) body.end.stop_id = String(endStopId);

    try{
      showToast("ƒêang t√¨m l·ªô tr√¨nh‚Ä¶", "warn");
      const data = await apiPost('/find-route', body);

      // Backend may return multi plans; pick selected or first
      const plans = data.plans || data.options || null;
      if (Array.isArray(plans) && plans.length){
        const idx = Number(data.selected_plan_index ?? 0);
        drawPlan(plans[Math.max(0, Math.min(idx, plans.length-1))]);
      } else if (data.summary && data.segments){
        drawPlan(data);
      } else if (data.plan && data.plan.summary){
        drawPlan(data.plan);
      } else {
        throw new Error("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu l·ªô tr√¨nh t·ª´ backend.");
      }
      showToast("ƒê√£ t√¨m th·∫•y l·ªô tr√¨nh.", "ok");
    } catch(err){
      showToast(`L·ªói t√¨m l·ªô tr√¨nh: ${err.message}`, "err");
    }
  }

  function maybeFindRoute(){
    // auto find when both selected
    if (startLatLng && endLatLng) findRoute();
  }

  // ===== Map click selection (fix tri·ªát ƒë·ªÉ) =====
  map.on('click', (e) => {
    if (isPickingStart){
      setStart(e.latlng, false);
      showToast("ƒê√£ ch·ªçn ƒëi·ªÉm xu·∫•t ph√°t", "ok");
      clearPicking();
      maybeFindRoute();
      return;
    }
    if (isPickingDest){
      setDestination(e.latlng, null, null);
      showToast("ƒê√£ ch·ªçn ƒëi·ªÉm ƒë·∫øn", "ok");
      clearPicking();
      maybeFindRoute();
      return;
    }
  });

  // ===== Stops in view =====
  let stopsRefreshTimer = null;
  async function refreshStopsInView(){
    if (!stopsEnabled) return;
    const b = map.getBounds();
    if (!b) return;
    const south = b.getSouth();
    const north = b.getNorth();
    const west  = b.getWest();
    const east  = b.getEast();
    const nums = [south, north, west, east].map(Number);
    if (!nums.every(n => Number.isFinite(n))) return;
    const payload = {
      // Support both naming styles (backend compatibility)
      south, west, north, east,
      min_lat: south, max_lat: north,
      min_lon: west,  max_lon: east,
      limit: 2000,
      connected_only: true
    };
    try{
      const data = await apiPost('/stops-bbox', payload);
      const stops = data.stops || [];
      stopsLayer.clearLayers();

      stops.forEach(s => {
        const lat = Number(s.stop_lat ?? s.lat);
        const lon = Number(s.stop_lon ?? s.lon);
        if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;
        const name = s.stop_name || s.name || "Tr·∫°m";
        const sid = String(s.stop_id ?? s.id ?? "");
        const m = L.circleMarker([lat, lon], { radius: 4.5, weight: 1.5, opacity: 0.9, fillOpacity: 0.7 });
        m.bindTooltip(name, { direction: "top", opacity: 0.95 });
        m.on('click', () => {
          setDestination(L.latLng(lat, lon), sid || null, name);
          showToast(`ƒê√£ ch·ªçn ƒë√≠ch: ${name}`, "ok");
          maybeFindRoute();
        });
        m.addTo(stopsLayer);
      });
    } catch(err){
      showToast(`Kh√¥ng t·∫£i ƒë∆∞·ª£c tr·∫°m trong v√πng: ${err.message}`, "err");
    }
  }

  map.on('moveend', () => {
    if (!stopsEnabled) return;
    clearTimeout(stopsRefreshTimer);
    stopsRefreshTimer = setTimeout(refreshStopsInView, 220);
  });

  // ===== POIs =====
  function renderPOIsOnMap(){
    poiLayer.clearLayers();
    TOUR_POIS.forEach(p => {
      const m = L.circleMarker([p.lat, p.lon], { radius: 7, weight: 2, opacity: 0.95, fillOpacity: 0.65 });
      m.bindTooltip(p.name, { direction: "top", opacity: 0.95 });
      m.on('click', () => selectPOI(p));
      m.addTo(poiLayer);
    });
  }

  async function selectPOI(p){
    // M·ªü popup chi ti·∫øt POI (·∫£nh + gi·ªõi thi·ªáu)
    openPoiModal(p);
    // Mark POI
    if (!poiMarker){
      poiMarker = L.marker([p.lat, p.lon], { title: p.name }).addTo(map);
    } else {
      poiMarker.setLatLng([p.lat, p.lon]);
    }
    poiMarker.bindPopup(`üèõÔ∏è ${p.name}`).openPopup();
    map.setView([p.lat, p.lon], Math.max(map.getZoom(), 15));

    // Find nearest stop to POI
    try{
      showToast(`ƒêang t√¨m tr·∫°m g·∫ßn nh·∫•t t·ªõi: ${p.name}‚Ä¶`, "warn");
      const data = await apiPost('/nearest-stops', { lat: p.lat, lon: p.lon, limit: 1 });
      const stops = data.stops || data.nearest || [];
      if (!stops.length) throw new Error("Kh√¥ng c√≥ tr·∫°m g·∫ßn nh·∫•t.");
      const s = stops[0];
      const lat = Number(s.stop_lat ?? s.lat);
      const lon = Number(s.stop_lon ?? s.lon);
      const sid = String(s.stop_id ?? s.id ?? "");
      const name = s.stop_name || s.name || sid || "Tr·∫°m g·∫ßn nh·∫•t";

      setDestination(L.latLng(lat, lon), sid || null, name);
      showToast(`Tr·∫°m g·∫ßn nh·∫•t: ${name}`, "ok");
      closeSubSheet();
      maybeFindRoute();
    } catch(err){
      showToast(`Kh√¥ng t√¨m ƒë∆∞·ª£c tr·∫°m g·∫ßn nh·∫•t: ${err.message}`, "err");
    }
  }

  function openPOIList(){
  const html = TOUR_POIS.map(p => `
    <div class="list-item">
      <div style="flex:1;min-width:0">
        <div class="li-title">${escapeHtml(p.name)}</div>
        <div class="li-sub">${escapeHtml(p.note || "")}</div>
      </div>
      <div class="li-actions">
        <button class="mini-btn" data-action="go" data-id="${escapeHtml(p.id)}">ƒêi</button>
        <button class="mini-btn ghost" data-action="view" data-id="${escapeHtml(p.id)}">Xem</button>
      </div>
    </div>
  `).join("");

  openSubSheet("ƒêi·ªÉm du l·ªãch", `
    <div class="list">
      ${html || "<div class='muted'>Ch∆∞a c√≥ d·ªØ li·ªáu ƒëi·ªÉm du l·ªãch.</div>"}
    </div>
  `);

  const body = document.getElementById('subBody');
  if (!body) return;

  body.onclick = async (e) => {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;

    const id = btn.getAttribute('data-id');
    const action = btn.getAttribute('data-action');
    const poi = TOUR_POIS.find(x => x.id === id);
    if (!poi) return;

    if (action === 'view'){
      await selectPOI(poi);
      return;
    }

    if (action === 'go'){
      setDestination({ lat: poi.lat, lng: poi.lon }, poi.name, null);
      closeSubSheet();
      await maybeFindRoute();
      return;
    }
  };
}

  // ===== Place search (Nominatim) =====
  async function geocodePlace(q){
    const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q + " H√† N·ªôi")}`;
    const res = await fetch(url, { headers: { "Accept": "application/json" } });
    const data = await res.json().catch(() => []);
    if (!Array.isArray(data) || !data.length) return null;
    return { lat: Number(data[0].lat), lon: Number(data[0].lon), name: data[0].display_name };
  }

  async function goPlace(){
    const q = placeInput.value.trim();
    if (q.length < 2) { showToast("Nh·∫≠p t√™n ƒë·ªãa ƒëi·ªÉm ƒë·ªÉ t√¨m.", "warn"); return; }
    try{
      showToast("ƒêang t√¨m ƒë·ªãa ƒëi·ªÉm‚Ä¶", "warn");
      const g = await geocodePlace(q);
      if (!g || !isFinite(g.lat) || !isFinite(g.lon)) throw new Error("Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm.");
      map.setView([g.lat, g.lon], 15);
      setDestination(L.latLng(g.lat, g.lon), null, q);
      showToast("ƒê√£ ch·ªçn ƒëi·ªÉm ƒë·∫øn.", "ok");
      maybeFindRoute();
    } catch(err){
      showToast(`L·ªói t√¨m ƒë·ªãa ƒëi·ªÉm: ${err.message}`, "err");
    }
  }

  // ===== GPS =====
  function requestGPS(){
    if (!navigator.geolocation) {
      showToast("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS.", "err");
      return;
    }
    showToast("ƒêang l·∫•y v·ªã tr√≠‚Ä¶", "warn");
    navigator.geolocation.getCurrentPosition((pos) => {
      gpsLatLng = L.latLng(pos.coords.latitude, pos.coords.longitude);
      if (!gpsMarker) gpsMarker = L.marker(gpsLatLng, { title: "V·ªã tr√≠ c·ªßa t√¥i" }).addTo(map);
      else gpsMarker.setLatLng(gpsLatLng);
      gpsMarker.bindPopup("V·ªã tr√≠ c·ªßa t√¥i").openPopup();

      // also set as start if not set
      if (!startLatLng) setStart(gpsLatLng, true);
      map.setView(gpsLatLng, Math.max(map.getZoom(), 15));
      showToast("ƒê√£ l·∫•y v·ªã tr√≠.", "ok");
      maybeFindRoute();
    }, (err) => {
      showToast(`Kh√¥ng l·∫•y ƒë∆∞·ª£c GPS: ${err.message}`, "err");
    }, { enableHighAccuracy: true, timeout: 12000, maximumAge: 5000 });
  }

  // ===== Event wiring =====
  btnToggleControls.addEventListener('click', () => {
    applyControlsHidden(!controlsHidden);
  });

  btnGPS.addEventListener('click', () => {
    clearPicking();
    requestGPS();
  });

  btnPickStart.addEventListener('click', () => {
    isPickingStart = !isPickingStart;
    isPickingDest = false;
    setFabActive(btnPickStart, isPickingStart);
    setFabActive(btnPickDest, false);
    map.getContainer().style.cursor = isPickingStart ? "crosshair" : "";
    if (isPickingStart) showToast("Ch·∫°m l√™n b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn ƒëi·ªÉm xu·∫•t ph√°t.", "warn");
  });

  btnPickDest.addEventListener('click', () => {
    isPickingDest = !isPickingDest;
    isPickingStart = false;
    setFabActive(btnPickDest, isPickingDest);
    setFabActive(btnPickStart, false);
    map.getContainer().style.cursor = isPickingDest ? "crosshair" : "";
    if (isPickingDest) showToast("Ch·∫°m l√™n b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn ƒëi·ªÉm ƒë·∫øn.", "warn");
  });

  btnToggleStops.addEventListener('click', async () => {
    stopsEnabled = !stopsEnabled;
    setFabActive(btnToggleStops, stopsEnabled);
    btnToggleStops.querySelector('span:last-child').textContent = stopsEnabled ? "·∫®n tr·∫°m xe" : "Hi·ªán tr·∫°m xe";
    if (!stopsEnabled) {
      stopsLayer.clearLayers();
      showToast("ƒê√£ ·∫©n tr·∫°m.", "ok");
      return;
    }
    showToast("ƒêang t·∫£i tr·∫°m trong v√πng‚Ä¶", "warn");
    await refreshStopsInView();
    showToast("ƒê√£ hi·ªÉn th·ªã tr·∫°m trong v√πng b·∫£n ƒë·ªì.", "ok");
  });

  btnNearest.addEventListener('click', async () => {
    if (!gpsLatLng && !startLatLng){
      showToast("H√£y l·∫•y v·ªã tr√≠ (GPS) ho·∫∑c ch·ªçn ƒëi·ªÉm xu·∫•t ph√°t tr∆∞·ªõc.", "warn");
      return;
    }
    const base = gpsLatLng || startLatLng;
    try{
      showToast("ƒêang t√¨m tr·∫°m g·∫ßn nh·∫•t‚Ä¶", "warn");
      const data = await apiPost('/nearest-stops', { lat: base.lat, lon: base.lng, limit: 12 });
      const stops = data.stops || [];
      if (!stops.length) throw new Error("Kh√¥ng t√¨m th·∫•y tr·∫°m g·∫ßn.");
      // show list in subsheet
      const items = stops.map(s => {
        const name = s.stop_name || s.name || "Tr·∫°m";
        const sid = String(s.stop_id ?? s.id ?? "");
        const d = Number(s.distance ?? s.distance_m ?? 0);
        return `<div class="list-item" data-sid="${sid}" data-lat="${Number(s.stop_lat ?? s.lat)}" data-lon="${Number(s.stop_lon ?? s.lon)}" data-name="${name.replaceAll('"','&quot;')}">
                  <div class="name">${name}</div>
                  <div class="meta">C√°ch ${fmtMeters(d)} ‚Ä¢ Ch·∫°m ƒë·ªÉ ƒë·∫∑t l√†m ƒëi·ªÉm ƒë·∫øn</div>
                </div>`;
      }).join("");
      openSubSheet("Tr·∫°m g·∫ßn b·∫°n", "Ch·∫°m m·ªôt tr·∫°m ƒë·ªÉ v·∫Ω l·ªô tr√¨nh t·ªõi tr·∫°m ƒë√≥", items);

      subBody.querySelectorAll('.list-item').forEach(el => {
        el.addEventListener('click', () => {
          const lat = Number(el.getAttribute('data-lat'));
          const lon = Number(el.getAttribute('data-lon'));
          const sid = el.getAttribute('data-sid') || null;
          const name = el.getAttribute('data-name') || null;
          setDestination(L.latLng(lat, lon), sid, name);
          closeSubSheet();
          showToast(`ƒê√£ ch·ªçn ƒë√≠ch: ${name}`, "ok");
          maybeFindRoute();
        });
      });
    } catch(err){
      showToast(`L·ªói: ${err.message}`, "err");
    }
  });

  btnClear.addEventListener('click', () => {
    clearPicking();
    clearRoute(true);
  });

  btnExpand.addEventListener('click', () => setSheetState(!sheet.classList.contains('expanded')));
  btnCloseSheet.addEventListener('click', () => setSheetState(false));

  btnPOIs.addEventListener('click', () => {
    renderPOIsOnMap();
    openPOIList();
  });

  subBack.addEventListener('click', () => closeSubSheet());

  btnPlaceGo.addEventListener('click', goPlace);
  placeInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') goPlace(); });

  // Drag handle to expand/collapse (simple)
  let dragStartY = null;
  handle.addEventListener('pointerdown', (e) => {
    dragStartY = e.clientY;
    handle.setPointerCapture(e.pointerId);
  });
  handle.addEventListener('pointerup', (e) => {
    if (dragStartY == null) return;
    const dy = e.clientY - dragStartY;
    if (dy > 25) setSheetState(false);
    if (dy < -25) setSheetState(true);
    dragStartY = null;
  });

  // Startup ping
  (async () => {
    try{
      await apiGet('/ping');
      showToast("K·∫øt n·ªëi backend th√†nh c√¥ng.", "ok");
    }catch(err){
      showToast(`Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c backend: ${err.message}`, "err");
    }
  })();

})();
// ===== Landing / Intro controller =====
const INTRO_SKIP_KEY = "busmaps_intro_skip_v1";

function openIntro(){
  const el = document.getElementById("introOverlay");
  if (!el) return;
  el.classList.add("is-open");
  el.setAttribute("aria-hidden", "false");
}

function closeIntro(){
  const el = document.getElementById("introOverlay");
  if (!el) return;
  el.classList.remove("is-open");
  el.setAttribute("aria-hidden", "true");
}

function shouldSkipIntro(){
  return localStorage.getItem(INTRO_SKIP_KEY) === "1";
}

function wireIntro(){
  const btn = document.getElementById("btnStartApp");
  const ck = document.getElementById("introSkip");

  if (ck) ck.checked = shouldSkipIntro();

  if (btn){
    btn.addEventListener("click", () => {
      if (ck && ck.checked) localStorage.setItem(INTRO_SKIP_KEY, "1");
      closeIntro();

      // N·∫øu b·∫°n mu·ªën tr√¨ ho√£n init app (t·ªëi ∆∞u h∆°n), xem m·ª•c 4 b√™n d∆∞·ªõi.
      // M·∫∑c ƒë·ªãnh: app ƒë√£ init s·∫µn, overlay ch·ªâ che t∆∞∆°ng t√°c.
    });
  }

  // Nh·∫•n ESC ƒë·ªÉ ƒë√≥ng intro (tu·ª≥ b·∫°n th√≠ch gi·ªØ hay b·ªè)
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeIntro();
  });
}

document.addEventListener("DOMContentLoaded", () => {
  wireIntro();

  if (shouldSkipIntro()) {
    closeIntro();
  } else {
    openIntro();
  }
});
// ===== End Landing / Intro controller =====

</script>

    <script>
    // PWA Service Worker
    (function(){
      if (!('serviceWorker' in navigator)) return;
      window.addEventListener('load', function(){
        navigator.serviceWorker.register('/service-worker.js').catch(function(err){
          console.warn('SW register failed', err);
        });
      });
    })();
    </script>
    
</body>
</html>
